---
title: "lulcc_brazil"
author: "Katherine Siegel"
date: "January 11, 2021"
output: html_document
---

## Description
Play with LUC models in Brazil

## Set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

### Open packages
library(tidyverse)
library(sf)
library(raster)
library(sp)
library(rgdal)
# library(lulcc)
# library(gsubfn)
# library(caret)
library(landscapemetrics)

#### Function to check correlation
cor.prob <- function (X, dfr = nrow(X) - 2) {
  R <- cor(X, use="pairwise.complete.obs")
  above <- row(R) < col(R)
  r2 <- R[above]^2
  Fstat <- r2 * dfr/(1 - r2)
  R[above] <- 1 - pf(Fstat, 1, dfr)
  R[row(R) == col(R)] <- NA
  R
}
flattenSquareMatrix <- function(m) {
  if( (class(m) != "matrix") | (nrow(m) != ncol(m))) stop("Must be a square matrix.") 
  if(!identical(rownames(m), colnames(m))) stop("Row and column names must be equal.")
  ut <- upper.tri(m)
  data.frame(i = rownames(m)[row(m)[ut]],
             j = rownames(m)[col(m)[ut]],
             cor=t(m)[ut],
             p=m[ut])
}
```

## Land cover maps
Create stack with 2008 and 2018 maps, read it in
```{r}
### Load rasters of 2008 and 2018 land cover classes
# obs_lc <- ObsLulcRasterStack(x = braz_lc,
#                              categories = c(1, 2, 3, 
#                                             4, 5, 6),
#                              labels = c(),
#                              t = c(0, 10))

### Get transition matrix
# obs_change <- crossTabulate(x = obs_lc,
#                             times = c(0, 10))
```

## Transition change prob
```{r}
### Brazil
### Open rasters
bra08 <- raster("/nfs/agfrontiers-data/Remote Sensing/classified_layers/Classified_SR/BRA/classi_BRA_dry_2008.tif")
bra18 <- raster("/nfs/agfrontiers-data/Remote Sensing/classified_layers/Classified_SR/BRA/classi_BRA_dry_2018.tif")

### Change
luc <- data.frame(lc08 = values(bra08),
                  lc18 = values(bra18))

### Raw tally matrix of change
mat <- table(luc[, c('lc08', 'lc18')])

### See as table
# kable(mat, format = "pandoc", caption = "Counts of land cover/use changes from 2018 (rows) to 2018 (columns)")

### Calculate probabilities
p_mat <- as.matrix(mat/rowSums(mat))
p_mat <- round(p_mat, 3)
kable(p_mat, format = "pandoc", caption = "Transition probability matrix of land cover/use changes from 2018 (rows) to 2018 (columns)")

### Bolivia
### Open rasters
bol08 <- raster("/nfs/agfrontiers-data/Remote Sensing/classified_layers/Classified_SR/BOL/classi_BOL_dry_2008.tif")
bol18 <- raster("/nfs/agfrontiers-data/Remote Sensing/classified_layers/Classified_SR/BOL/classi_BOL_dry_2018.tif")

### Change
luc <- data.frame(lc08 = values(bol08),
                  lc18 = values(bol18))

### Raw tally matrix of change
mat <- table(luc[, c('lc08', 'lc18')])

### See as table
# kable(mat, format = "pandoc", caption = "Counts of land cover/use changes from 2018 (rows) to 2018 (columns)")

### Calculate probabilities
p_mat <- as.matrix(mat/rowSums(mat))
p_mat <- round(p_mat, 3)
kable(p_mat, format = "pandoc", caption = "Transition probability matrix of land cover/use changes from 2018 (rows) to 2018 (columns)")

### Peru
### Open rasters
per08 <- raster("/nfs/agfrontiers-data/Remote Sensing/classified_layers/Classified_SR/PER/classi_PER_dry_2008.tif")
per18 <- raster("/nfs/agfrontiers-data/Remote Sensing/classified_layers/Classified_SR/PER/classi_PER_dry_2018.tif")

### Change
luc <- data.frame(lc08 = values(per08),
                  lc18 = values(per18))

### Raw tally matrix of change
mat <- table(luc[, c('lc08', 'lc18')])

### See as table
# kable(mat, format = "pandoc", caption = "Counts of land cover/use changes from 2018 (rows) to 2018 (columns)")

### Calculate probabilities
p_mat <- as.matrix(mat/rowSums(mat))
p_mat <- round(p_mat, 3)
kable(p_mat, format = "pandoc", caption = "Transition probability matrix of land cover/use changes from 2018 (rows) to 2018 (columns)")


```


## Steps from 2020 AAG Presentation
Regression models for different sets of variables for Brazil

### Sample on grid
```{r}
### Open buffer polygon
bra_buff <- st_read("/nfs/agfrontiers-data/Remote Sensing/KS files/JamanBuffer_reproj.shp") %>%
  st_transform(., crs = "+proj=aea +lat_0=-32 +lon_0=-60 +lat_1=-5 +lat_2=-42 +x_0=0 +y_0=0
+ellps=aust_SA +units=m +no_defs")

### Make sampling grid, point every 1 km
bra_samples <- bra_buff %>%
  
  ### Make samples (every 300 m)
  st_make_grid(cellsize = c(300, 300),
               what = "centers") %>%
  
  ### Convert to sf
  st_sf() %>%
  
  ### Add identifiers
  mutate(lon = st_coordinates(.)[, 1],
         lat = st_coordinates(.)[, 2])

### Add UID
bra_samples$uid <- 1:nrow(bra_samples)

### Open brazil 2008 map
bra_2008 <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/classi_bra_dry_2008_102033.tif")

### Extract land cover type to sample points
bra_samples_2008 <- raster::extract(bra_2008, 
                                    bra_samples, 
                                    df = TRUE)

### See how many were forest in 2008
# b_2008_summ <- bra_samples_2008 %>%
#   group_by(classi_bra_dry_2008_102033) %>%
#   summarise(n_per_class = n())
### 0 = no data, 1 = agriculture, 2 = forest, 3 = bare soil, 4 = urban, 5 = wetland, 6 = desert, and 7 = water
### 279914 forested points in 2008

### Add uid back in
bra_samples_2008$uid <- bra_samples$uid

### Merge bra_samples_2008 with bra_samples
bra_samples <- merge(bra_samples, 
                     bra_samples_2008,
                     by = "uid")
rm(bra_samples_2008)

### Subset to forested points
bra_forest_samp <- bra_samples %>%
  subset(classi_bra_dry_2008_102033 == "2")

### Rename cols
bra_forest_samp <- bra_forest_samp %>%
  dplyr::select(uid, lon, lat, 
                lc_2008 = classi_bra_dry_2008_102033)

# ### Write out sample pts
# st_write(bra_forest_samp,
#          "D:/dinamica/sample_pts_model/bra_forest.shp")

### Open brazil 2018 map
bra_2018 <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/classi_bra_dry_2018_102033.tif")

### Extract 2018 land cover class
luc_bra <- raster::extract(bra_2018, 
                           bra_forest_samp, 
                           df = TRUE)

### Add UID and merge with sf
luc_bra$uid <- bra_forest_samp$uid
luc_bra <- merge(bra_forest_samp, 
                 luc_bra,
                 by = "uid")

### Rename cols
luc_bra <- luc_bra %>%
  dplyr::select(uid, lon, lat, 
                lc_2008,
                lc_2018 = classi_bra_dry_2018_102033,
                geometry)

### Write out sample pts
st_write(luc_bra,
         "/nfs/agfrontiers-data/luc_model/bra_forest.shp")

# ### Summarize transitions
# luc_bra_summ <- luc_bra %>%
#   group_by(lc_2018) %>%
#   summarise(n_transitions = n())
# luc_bra_summ <- luc_bra_summ %>%
#   mutate(portion_pts = n_transitions/279914*100)

### 94% of forested points remained in forest cover
### 4.9% converted from forest to ag
### 0.7% converted from forest to bare soil
### 0.3% converted from forest to wetland
### < 0.1% converted to urban or water

### Drop intermediate dfs/rasters
rm(bra_2008, bra_2018, bra_buff, bra_samples)

### OLD CODE
# ### Drop points that transitioned to other land uses
# luc_bol_fa <- luc_bol %>%
#   subset(classi_BOL_dry_2018 < 3)
# 
# ### Make sf
# st_geometry(luc_bol_fa) <- luc_bol_fa$geometry
# 
# ### Rename cols
# luc_bol_fa <- luc_bol_fa %>%
#   dplyr::select(uid, 
#                 lc_2008 = classi_BOL_dry_2008,
#                 lc_2018 = classi_BOL_dry_2018,
#                 lon, lat, geometry)
# 
# ### Save sf df
# st_write(luc_bol_fa, "bol_gridpts_for_regression.shp")
```

### Extract neighborhood values to pts
```{r}
### Open sample pts
bra_pts <- st_read("/nfs/agfrontiers-data/luc_model/bra_forest.shp")

### Open brazil neighbor pts raster
bra_neigh <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/bra_perc_diff.tif")

### Extract neighborhood pixel values to brazil pts
bra_neigh_dat <- extract(bra_neigh, 
                         bra_pts,
                         df = TRUE)

### Give it a uid
bra_neigh_dat$uid <- bra_pts$uid

### Merge with sf
bra_neigh_dat <- merge(bra_pts,
                       bra_neigh_dat,
                       by = "uid")

### Write it out
st_write(bra_neigh_dat,
         "/nfs/agfrontiers-data/luc_model/bra_forest_neighs.shp")
```


### UIDs of points with complete data
```{r}
### Open sample points
bra_neigh_dat <- st_read("/nfs/agfrontiers-data/luc_model/bra_forest_neighs.shp")

### Open rasterbrick, all layers
# bra_layers_all <- brick("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/brazil_all_layers.tif")
bra_layers_all <- brick("/nfs/agfrontiers-data/luc_model/brazil_all_layers.tif")

## Convert NAs to 0 in ag reform layer
bra_layers_all[[23]][is.na(bra_layers_all[[23]][])] <- 0

### Extract values to pts
bra_dat_all <- extract(bra_layers_all, 
                       bra_neigh_dat,
                       df = TRUE)

### Rename columns
colnames(bra_dat_all) <- c("id", "aspect", "mines", 
                           "roads", "rivers", 
                           "cities", "elev", 
                           "popdens", "poverty", 
                           "ppt", "prot_status", 
                           "slope", "soil", 
                           "crop_suit", "field_res",
                           "paddd", "non_all_land",
                           "dist_ill_mines", "dist_ag",
                           "dist_fires", "fire_dens",
                           "dist_pr_rr",
                           "dist_pr_dams",
                           "agref_sett", "cattle")

### Give it a uid
bra_dat_all$uid <- luc_bra$uid

### Merge with sf
bra_dat_all <- merge(luc_bra,
                     bra_dat_all,
                     by = "uid")

### Version without geometry
bra_dat_all_simp <- bra_dat_all
bra_dat_all_simp$geometry <- NULL

### Drop incomplete rows
bra_dat_all_simp <- bra_dat_all_simp[complete.cases(bra_dat_all_simp), ]

### Drop rows where prot_status = 0 (??)
bra_dat_all_simp <- bra_dat_all_simp %>%
  filter(., !prot_status == "0")

### Get uids
uid_comp <- bra_dat_all_simp$uid

### Add geom back to visualize
# st_geometry(bol_dat_all) <- bol_dat_all$geometry
bra_dat_all <- bra_dat_all %>%
  filter(uid %in% uid_comp)

### Write out sample pts
st_write(bra_dat_all,
         "/nfs/agfrontiers-data/luc_model/brazil_f_data.shp")
```

#### Combine with neighbor pix values
```{r}
### Open brazil_f_data
bra_data <- st_read("/nfs/agfrontiers-data/luc_model/brazil_f_data.shp")

### Fix col names
colnames(bra_data) <- c("uid", "lon", "lat", "lc_2008", "lc_2018",
                        "id", "aspect", "mines", 
                        "roads", "rivers", 
                        "cities", "elev", 
                        "popdens", "poverty", 
                        "ppt", "prot_status", 
                        "slope", "soil", 
                        "crop_suit", "field_res",
                        "paddd", "non_all_land",
                        "dist_ill_mines", "dist_ag",
                        "dist_fires", "fire_dens",
                        "dist_pr_rr",
                        "dist_pr_dams",
                        "agref_sett", "cattle", "geometry")

bra_neigh_dat <- bra_neigh_dat %>%
  dplyr::select(uid, lon, lat, lc_2008, lc_2018, perc_diff = br_prc_, geometry)

### Versions wo geometry
bra_data_df <- bra_data
st_geometry(bra_data_df) <- NULL
bra_neigh_df <- bra_neigh_dat
st_geometry(bra_neigh_df) <- NULL

### Merge with neighbors
bra_dat_all <- merge(bra_data_df, bra_neigh_df,
                     by = c("uid", "lon", "lat", "lc_2008", "lc_2018"),
                     all.x = TRUE)

### Write out sample pts
write_csv(bra_dat_all,
         "/nfs/agfrontiers-data/luc_model/brazil_data_for_model.csv")
```

#### Add factor cols
```{r}
### Make column for transition/none
bra_dat_all <- bra_dat_all %>%
  mutate(transition = ifelse(lc_2018 == "2",
                             "no_change",
                             ifelse(lc_2018 == "1",
                                    "f_to_ag", 
                                    "other_change")),
         trans_rc = ifelse(transition == "no_change",
                           "0", ifelse(transition == "f_to_ag",
                                       "1", "2")))

### Make columns factor
fact_cols <- c("uid", "prot_status", 
               "paddd", "agref_sett",
               "lc_2018", "trans_rc")
bra_dat_all <- bra_dat_all %>%
  mutate_each_(funs(factor(.)), fact_cols)
```

### Check correlations 
Restrict to points that did not change or points that converted to ag
```{r}
### Restrict to transitions
bra_dat_use <- bra_dat_all %>% 
  filter(trans_rc == "1" | trans_rc == "0")

### Make corr table
cor_table_bra <- flattenSquareMatrix(cor.prob(bra_dat_use[, c(2, 3, 7:15, 17:20, 22:28, 30, 31)]))

### Look at vars with abs(cor.prob) > 0.66 and pvalue < 0.05
cor_table_bra <- subset(cor_table_bra, 
                        abs(cor) > 0.66 & p <= 0.05)

write.csv(cor_table_bra,
          file = "/nfs/agfrontiers-data/luc_model/brazil_correlations.csv")

### Dist to cities and dist to proposed dams (0.901895817)
### Dist to illegal mines and dist to proposed dams (0.687864047)
### Dist to field research and dist to proposed railroads (0.751940629998678)
### Latitude and distance to cities (-0.906809952881162)
### Latitude and ppt (0.721263744)
### Latitude and distance to illegal mines (-0.703078025923246)
### Latitude and distance to proposed dams (-0.997039325865242)
### Longitude and distance to illegal mines (0.78014565492577)
### Longitude and distance to proposed RR (-0.899933806697024)
### Non allocated land and cattle (-0.994488132)
### Pop density and poverty (0.987581678)
### Population density and % non-allocated land (0.998261478)
### Pop density and cattle (-0.992973607)
### Poverty and non-allocated public land (0.989114865)
### Poverty rate and cattle (-0.99890119)
### ppt and distance to illegal mines (-0.854715014)
### ppt and distance to proposed dams (-0.722421364)
```

### Model 1
Standard LUC variables only

#### Regression
```{r}
### Variables to drop due to correlations:
### latitude, longitude (dropped because don't have mechanism)
### ppt

### Run regression
fit_bra <- glm(trans_rc ~ aspect + slope + elev +
                 roads + rivers + mines + cities +
                 crop_suit + popdens + poverty +
                 # (1|uid) + lon +
                 soil + perc_diff + prot_status,
               data = bra_dat_use,
               family = binomial(link = "logit"))

### Write out coefficients
fit_bra_summ <- summary(fit_bra)
fit_bra_coeff <- as.data.frame(fit_bra_summ$coefficients)
write.csv(fit_bra_coeff, 
          file = "/nfs/agfrontiers-data/luc_model/fit_bra_model1.csv")
```

### Model 2
Discourse analysis variables only:
* field research  
* PADDD  
* non-allocated land  
* distance to illegal mining  
* distance to ag  
* distance to fires  
* fire density  
* distance to proposed railroads  
* distance to proposed dams  
* ag reform settlements  
* head of cattle 

#### Regression
Need to drop some vars because of correlations:  
* distance to field research (distance to proposed railroads)  
* distance to proposed dams (distance to illegal mines)
```{r}
### Run regression
fit_bra_m2 <- glm(trans_rc ~ paddd + non_all_land +
                    # field_res +
                    dist_ill_mines +
                    dist_ag + dist_fires +
                    fire_dens + dist_pr_rr +
                    # dist_pr_dams + 
                    agref_sett +
                    cattle,
                  data = bra_dat_use,
                  family = binomial(link = "logit"))

### Write out coefficients
fit_bra2_summ <- summary(fit_bra_m2)
fit_bra2_coeff <- as.data.frame(fit_bra2_summ$coefficients)
write.csv(fit_bra2_coeff, 
          file = "/nfs/agfrontiers-data/luc_model/fit_bra_model2.csv")
```

### Model 3
All standard variables and discourse analysis variables
```{r}
### Run regression
fit_bra_m3 <- glm(trans_rc ~ aspect + slope + elev +
                 roads + rivers + mines + cities +
                 crop_suit + popdens + poverty +
                 # (1|uid) + lon +
                 soil + perc_diff + prot_status +
                   paddd + non_all_land +
                    # field_res +
                    dist_ill_mines +
                    dist_ag + dist_fires +
                    fire_dens + dist_pr_rr +
                    # dist_pr_dams + 
                    agref_sett +
                    cattle,
                  data = bra_dat_use,
                  family = binomial(link = "logit"))

### Write out coefficients
fit_bra3_summ <- summary(fit_bra_m3)
fit_bra3_coeff <- as.data.frame(fit_bra3_summ$coefficients)
write.csv(fit_bra3_coeff, 
          file = "/nfs/agfrontiers-data/luc_model/fit_bra_model3.csv")
```

### Model 4
Statistically significant variables from Model 1 + qualitatively significant variables from discourse analysis
Model 1 vars: roads, perc_diff, lon, slope, mines, prot status 20, rivers, soil, prot status 10, crop suit, elev
Model 2 vars: PADDD, non-allocated public land, dist to fire, fire density, proposed railroads, proposed dams, cattle
```{r}
### Run regression
fit_bra_m4 <- glm(trans_rc ~ slope + elev +
                 roads + rivers + mines + 
                 crop_suit + soil + perc_diff + prot_status +
                   paddd + non_all_land +
                    dist_ag + dist_fires +
                    fire_dens + dist_pr_rr +
                    cattle,
                  data = bra_dat_use,
                  family = binomial(link = "logit"))

### Write out coefficients
fit_bra4_summ <- summary(fit_bra_m4)
fit_bra4_coeff <- as.data.frame(fit_bra4_summ$coefficients)
write.csv(fit_bra3_coeff, 
          file = "/nfs/agfrontiers-data/luc_model/fit_bra_model4.csv")
```
### Compare model performance
```{r}
### AIC
AIC(fit_bra, fit_bra_m2,
    fit_bra_m3, fit_bra_m4) ### Model 3 has lowest AIC

### anova
anova(fit_bra, fit_bra_m2,
      fit_bra_m3, fit_bra_m4,
      test = "Chisq")
anova(fit_bra_m2, fit_bra_m3, test = "Chisq") ## 3 better than 2
anova(fit_bra_m3, fit_bra_m4, test = "Chisq") ## 4 better than 3
anova(fit_bra, fit_bra_m2, test = "Chisq")
anova(fit_bra, fit_bra_m4, test = "Chisq") ## 4 better than 1
```

## Brick with 2018 neighbors
```{r}
### Open rasterbrick
bra_layers_all <- brick("/nfs/agfrontiers-data/luc_model/brazil_all_layers.tif")

### Rename columns
names(bra_layers_all) <- c("aspect", "mines", 
                           "roads", "rivers", 
                           "cities", "elev", 
                           "popdens", "poverty", 
                           "ppt", "prot_status", 
                           "slope", "soil", 
                           "crop_suit", "field_res",
                           "paddd", "non_all_land",
                           "dist_ill_mines", "dist_ag",
                           "dist_fires", "fire_dens",
                           "dist_pr_rr",
                           "dist_pr_dams",
                           "agref_sett", "cattle")

### Open 2018 percent of neighboring pixels raster
neigh_2018 <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/bra18_perc_diff.tif")

### Brick with the others
bra_18_all <- addLayer(bra_layers_all, neigh_2018)
names(bra_18_all)[25] <- "perc_diff"
```

# ANALYZE MODEL OUTPUT
Analyze outputs from predict_luc.R

## Analyze Monte Carlo simulations for buffer
Output from predict_luc.R
```{r}
### Model 1
m1_mc <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_1_project/brazil_projected_loss.csv") 

### Make long, add value in sq km
m1_mc <- m1_mc %>%
  gather(simulation, value, 'X1206650788.19651':'X1206128094.78375') 
m1_mc <- m1_mc %>%
  mutate(value_km2 = value/1000000)

### Take mean
mean(m1_mc$value_km2)

### Histogram
options(scipen=10000)
m1_hist <- ggplot(m1_mc, aes(x = value_km2)) + 
  geom_histogram() +
  xlab("Square km of forest loss") +
  ylab("Number of simulations")

### Model 2
m2_mc <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_2_project/brazil_2_projected_loss.csv") 

### Make long, add value in sq km
m2_mc <- m2_mc %>%
  gather(simulation, value, 'X1286505026.92842':'X1287753733.3947') 
m2_mc <- m2_mc %>%
  mutate(value_km2 = value/1000000)

### Take mean
mean(m2_mc$value_km2)
sd(m2_mc$value_km2)

### Histogram
options(scipen=10000)
m2_hist <- ggplot(m2_mc, aes(x = value_km2)) + 
  geom_histogram() +
  xlab("Square km of forest loss") +
  ylab("Number of simulations")
  
### Model 3
m3_mc <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_3_project/brazil_3_projected_loss.csv") 

### Make long, add value in sq km
m3_mc <- m3_mc %>%
  gather(simulation, value, 'X1278826561.73412':'X1279344756.92473.1') 
m3_mc <- m3_mc %>%
  mutate(value_km2 = value/1000000)

### Take mean
mean(m3_mc$value_km2)
sd(m3_mc$value_km2)

### Histogram
options(scipen=10000)
m3_hist <- ggplot(m3_mc, aes(x = value_km2)) + 
  geom_histogram() +
  xlab("Square km of forest loss") +
  ylab("Number of simulations")

### Model 4
m4_mc <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_4_project/brazil_4_projected_loss.csv") 

### Make long, add value in sq km
m4_mc <- m4_mc %>%
  gather(simulation, value, 'X1275409712.19598':'X1275732684.54569') 
m4_mc <- m4_mc %>%
  mutate(value_km2 = value/1000000)

### Take mean
mean(m4_mc$value_km2)
sd(m4_mc$value_km2)

### Histogram
options(scipen=10000)
m4_hist <- ggplot(m4_mc, aes(x = value_km2)) + 
  geom_histogram() +
  xlab("Square km of forest loss") +
  ylab("Number of simulations")

### Add columns to dfs
m1_mc <- m1_mc %>%
  mutate(model = "model1")
m2_mc <- m2_mc %>%
  mutate(model = "model2")
m3_mc <- m3_mc %>%
  mutate(model = "model3")
m4_mc <- m4_mc %>%
  mutate(model = "model4")

### rbind
all_models <- rbind(m1_mc, m2_mc, 
                    m3_mc, m4_mc)

### Plot
ggplot(all_models, aes(x = value_km2, color = model)) +
  geom_density() +
  xlab("Square km of forest converted to agriculture") +
  ylab("Density")
ggsave("/nfs/agfrontiers-data/luc_model/brazil_allmodels_area_defor.png")
```
## Original forest cover in buffer + park
```{r}
### 2008
forest_08 <- as.data.frame(bra_2008) %>%
    group_by(classi_bra_dry_2008_102033) %>%
    tally() %>%
    mutate(area = n * res(bra_2008)[1] * res(bra_2008)[2])

### 2018
forest_18 <- as.data.frame(bra_2018) %>%
    group_by(classi_bra_dry_2018_102033) %>%
    tally() %>%
    mutate(area = n * res(bra_2018)[1] * res(bra_2018)[2])
```
## Analyze Monte Carlo simulations for JNF
Output from predict_luc.R
```{r}
##############
### Model 1
##############
m1_mc_1 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m1_jamanxim_forestloss_1.csv") 
m1_mc_2 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m1_jamanxim_forestloss_2.csv") 
m1_mc_3 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m1_jamanxim_forestloss_3.csv") 
m1_mc_4 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m1_jamanxim_forestloss_4.csv") 
m1_mc_5 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m1_jamanxim_forestloss_5.csv") 

### Combine
m1_mc_jnf <- rbind(m1_mc_1, m1_mc_2, 
                   m1_mc_3, m1_mc_4,
                   m1_mc_5)

### Value in sq km
m1_mc_jnf <- m1_mc_jnf %>%
  mutate(value_km2 = x/1000000)

### Take mean
mean(m1_mc_jnf$value_km2)
sd(m1_mc_jnf$value_km2)

##############
### Model 2
##############
m2_mc_1 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m2_jamanxim_forestloss_1.csv") 
m2_mc_2 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m2_jamanxim_forestloss_2.csv") 
m2_mc_3 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m2_jamanxim_forestloss_3.csv") 
m2_mc_4 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m2_jamanxim_forestloss_4.csv") 
m2_mc_5 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m2_jamanxim_forestloss_5.csv") 

### Combine
m2_mc_jnf <- rbind(m2_mc_1, m2_mc_2, 
                   m2_mc_3, m2_mc_4,
                   m2_mc_5)

### Value in sq km
m2_mc_jnf <- m2_mc_jnf %>%
  mutate(value_km2 = x/1000000)

### Take mean
mean(m2_mc_jnf$value_km2)
sd(m2_mc_jnf$value_km2)

  
##############
### Model 3
##############
m3_mc_1 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m3_jamanxim_forestloss_1.csv") 
m3_mc_2 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m3_jamanxim_forestloss_2.csv") 
m3_mc_3 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m3_jamanxim_forestloss_3.csv") 
m3_mc_4 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m3_jamanxim_forestloss_4.csv") 
m3_mc_5 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m3_jamanxim_forestloss_5.csv") 

### Combine
m3_mc_jnf <- rbind(m3_mc_1, m3_mc_2, 
                   m3_mc_3, m3_mc_4,
                   m3_mc_5)

### Value in sq km
m3_mc_jnf <- m3_mc_jnf %>%
  mutate(value_km2 = x/1000000)

### Take mean
mean(m3_mc_jnf$value_km2)
sd(m3_mc_jnf$value_km2)

##############
### Model 4
##############
m4_mc_1 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m4_jamanxim_forestloss_1.csv") 
m4_mc_2 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m4_jamanxim_forestloss_2.csv") 
m4_mc_3 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m4_jamanxim_forestloss_3.csv") 
m4_mc_4 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m4_jamanxim_forestloss_4.csv") 
m4_mc_5 <- read.csv("/nfs/agfrontiers-data/luc_model/brazil_m4_jamanxim_forestloss_5.csv") 

### Combine
m4_mc_jnf <- rbind(m4_mc_1, m4_mc_2, 
                   m4_mc_3, m4_mc_4,
                   m4_mc_5)

### Value in sq km
m4_mc_jnf <- m4_mc_jnf %>%
  mutate(value_km2 = x/1000000)

### Take mean
mean(m4_mc_jnf$value_km2)
sd(m4_mc_jnf$value_km2)

### Add columns to dfs
m1_mc_jnf <- m1_mc_jnf %>%
  mutate(Model = "LUC")
m2_mc_jnf <- m2_mc_jnf %>%
  mutate(Model = "DA")
m3_mc_jnf <- m3_mc_jnf %>%
  mutate(Model = "LUC & DA")
m4_mc_jnf <- m4_mc_jnf %>%
  mutate(Model = "Refined LUC & DA")

### rbind
all_models_jnf <- rbind(m1_mc_jnf, m2_mc_jnf, 
                        m3_mc_jnf, m4_mc_jnf)

### Plot
ggplot(all_models_jnf, aes(x = value_km2, color = Model)) +
  geom_density() +
  xlab("Square km of forest converted to agriculture, 2018-2028") +
  ylab("Density") + 
  theme_bw(base_size=15) +
  scale_color_brewer(palette = "Dark2") + 
  NULL
ggsave("/nfs/agfrontiers-data/luc_model/brazil_allmodels_area_defor_jaman.png")

# ggplot(all_models_jnf, aes(x = Model, y = value_km2, color = Model)) +
#   geom_boxplot() +
#   scale_color_brewer(palette = "Dark2") + 
#   NULL
```
##### Compare to observed forest loss in JNF
```{r}
### Open brazil 2008 map
bra_2008 <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/classi_bra_dry_2008_102033.tif")

### Open brazil 2018 map
bra_2018 <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/classi_bra_dry_2018_102033.tif")

### Open JNF without buffer
jaman <- st_read("/nfs/agfrontiers-data/Case Study Info/Brazil/JamanBuffer/jamanxim_wdpa_march21_102033.shp")

### Crop LUC maps
jaman_08 <- crop(bra_2008, jaman)
jaman_08 <- mask(jaman_08, jaman)
jaman_18 <- crop(bra_2018, jaman)
jaman_18 <- mask(jaman_18, jaman)

### Forest in 2008
forest_08_jaman <- as.data.frame(jaman_08) %>%
    group_by(classi_bra_dry_2008_102033) %>%
    tally() %>%
    mutate(area = n * res(jaman_08)[1] * res(jaman_08)[2])

### Forest in 2018
forest_18_jaman <- as.data.frame(jaman_18) %>%
    group_by(classi_bra_dry_2018_102033) %>%
    tally() %>%
    mutate(area = n * res(jaman_18)[1] * res(jaman_18)[2])

### Calculate forested area lost 
f_lost_jaman <- (12557664259-12238130351)/1000000
```
## Add Simulations
Add up simulated maps
```{r}
#############
### Model 1
#############
### Open rasters
r1 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m1_stacked_1.tif")
r2 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m1_stacked_2.tif")
r3 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m1_stacked_3.tif")
r4 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m1_stacked_4.tif")
r5 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m1_stacked_5.tif")

### Stack
r_stack <- stack(r1, r2, r3, r4, r5)

### Add raster values
r_add <- calc(r_stack, sum)

### Save output
writeRaster(r_add, 
            "/nfs/agfrontiers-data/luc_model/brazil_m1_stacked_all.tif")

#############
### Model 2
#############
### Open rasters
r1 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m2_stacked_1.tif")
r2 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m2_stacked_2.tif")
r3 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m2_stacked_3.tif")
r4 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m2_stacked_4.tif")
r5 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m2_stacked_5.tif")

### Stack
r_stack <- stack(r1, r2, r3, r4, r5)

### Add raster values
r_add <- calc(r_stack, sum)

### Save output
writeRaster(r_add, 
            "/nfs/agfrontiers-data/luc_model/brazil_m2_stacked_all.tif")

#############
### Model 3
#############
### Open rasters
r1 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m3_stacked_1.tif")
r2 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m3_stacked_2.tif")
r3 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m3_stacked_3.tif")
r4 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m3_stacked_4.tif")
r5 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m3_stacked_5.tif")

### Stack
r_stack <- stack(r1, r2, r3, r4, r5)

### Add raster values
r_add <- calc(r_stack, sum)

### Save output
writeRaster(r_add, 
            "/nfs/agfrontiers-data/luc_model/brazil_m3_stacked_all.tif")

#############
### Model 4
#############
### Open rasters
r1 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m4_stacked_1.tif")
r2 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m4_stacked_2.tif")
r3 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m4_stacked_3.tif")
r4 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m4_stacked_4.tif")
r5 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m4_stacked_5.tif")

### Stack
r_stack <- stack(r1, r2, r3, r4, r5)

### Add raster values
r_add <- calc(r_stack, sum)

### Save output
writeRaster(r_add, 
            "/nfs/agfrontiers-data/luc_model/brazil_m4_stacked_all.tif")
```

## Projected loss (PAs only)
Based on stacked simulations
### Jamanxim
JNF lost 319.534 km2 forest from 2008-2018
```{r}
### Calculate forest loss as # pixels
### Open brazil 2008 map
bra_2008 <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/classi_bra_dry_2008_102033.tif")

### Open brazil 2018 map
bra_2018 <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/classi_bra_dry_2018_102033.tif")

### Open JNF without buffer
jaman <- st_read("/nfs/agfrontiers-data/Case Study Info/Brazil/JamanBuffer/jamanxim_wdpa_march21_102033.shp")

### Crop LUC maps
jaman_08 <- crop(bra_2008, jaman)
jaman_08 <- mask(jaman_08, jaman)
jaman_18 <- crop(bra_2018, jaman)
jaman_18 <- mask(jaman_18, jaman)

### Forest in 2008
forest_08_jaman <- as.data.frame(jaman_08) %>%
    group_by(classi_bra_dry_2008_102033) %>%
    tally()
### 13958475

### Forest in 2018
forest_18_jaman <- as.data.frame(jaman_18) %>%
    group_by(classi_bra_dry_2018_102033) %>%
    tally()
### 13603297

### Calculate forest loss
pix_lost <- 13958475-13603297
### 355178 pixels
```

#### Model 1
```{r}
### Open stacked raster
j_m1 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m1_stacked_all.tif")

### Restrict to JNF
j_m1 <- crop(j_m1, jaman)
j_m1 <- mask(j_m1, jaman)

### Convert to df
j_m1_df <- as.data.frame(j_m1)

### To vector
j_m1_df <- dplyr::pull(j_m1_df, brazil_m1_stacked_all)

### Descending order
j_m1_df <- sort(j_m1_df, decreasing = TRUE)

### Get top values
j_m1_top <- head(j_m1_df, 355178)

### Get range of those values
range(j_m1_top)
### 104-999

### So if the value is >= 104, it converts to agriculture

### Stack 2018 jaman and PP 
j_m1_stack <- stack(jaman_18, j_m1)

### Reclassification function
rc_m1 <- function(x1, x2) {
  ifelse((x1 == 2 & x2 >= 104), 1, x1)
}

## Make output raster
j_m1_projected <- overlay(j_m1_stack, fun = rc_m1)
  
### Save raster
writeRaster(j_m1_projected,
            filename = "/nfs/agfrontiers-data/luc_model/brazil_1_projected_map.tif",
            format = "GTiff",
            overwrite = TRUE,
            options = c("INTERLEAVE=BAND","COMPRESS=LZW"))

### Plot 
my_col = c('darkgoldenrod1','darkgreen','beige','red', 'blue', 'cyan')
plot(j_m1_projected, legend = FALSE, col = my_col)
legend(x = 'bottomleft', legend = c("Ag", "Forest", "Bare", "Urban", "Water", "Wetlands"), 
       fill = my_col)

```

#### Model 2
```{r}
### Open stacked raster
j_m2 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m2_stacked_all.tif")

### Restrict to JNF
j_m2 <- crop(j_m2, jaman)
j_m2 <- mask(j_m2, jaman)

### Convert to df
j_m2_df <- as.data.frame(j_m2)

### To vector
j_m2_df <- dplyr::pull(j_m2_df, brazil_m2_stacked_all)

### Descending order
j_m2_df <- sort(j_m2_df, decreasing = TRUE)

### Get top values
j_m2_top <- head(j_m2_df, 355178)

### Get range of those values
range(j_m2_top)
### 322-999

### So if the value is >= 322, it converts to agriculture

### Stack 2018 jaman and PP 
j_m2_stack <- stack(jaman_18, j_m2)

### Reclassification function
rc_m2 <- function(x1, x2) {
  ifelse((x1 == 2 & x2 >= 322), 1, x1)
}

## Make output raster
j_m2_projected <- overlay(j_m2_stack, fun = rc_m2)
  
### Save raster
writeRaster(j_m2_projected,
            filename = "/nfs/agfrontiers-data/luc_model/brazil_2_projected_map.tif",
            format = "GTiff",
            overwrite = TRUE,
            options = c("INTERLEAVE=BAND","COMPRESS=LZW"))

### Plot 
# my_col = c('darkgoldenrod1','darkgreen','beige','red', 'blue', 'cyan')
plot(j_m2_projected, legend = FALSE, col = my_col)
legend(x = 'bottomleft', legend = c("Ag", "Forest", "Bare", "Urban", "Water", "Wetlands"), 
       fill = my_col)

```

#### Model 3
```{r}
### Open stacked raster
j_m3 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m3_stacked_all.tif")

### Restrict to JNF
j_m3 <- crop(j_m3, jaman)
j_m3 <- mask(j_m3, jaman)

### Convert to df
j_m3_df <- as.data.frame(j_m3)

### To vector
j_m3_df <- dplyr::pull(j_m3_df, brazil_m3_stacked_all)

### Descending order
j_m3_df <- sort(j_m3_df, decreasing = TRUE)

### Get top values
j_m3_top <- head(j_m3_df, 355178)

### Get range of those values
range(j_m3_top)
### 338-999

### So if the value is >= 338, it converts to agriculture

### Stack 2018 jaman and PP 
j_m3_stack <- stack(jaman_18, j_m3)

### Reclassification function
rc_m3 <- function(x1, x2) {
  ifelse((x1 == 2 & x2 >= 338), 1, x1)
}

## Make output raster
j_m3_projected <- overlay(j_m3_stack, fun = rc_m3)
  
### Save raster
writeRaster(j_m3_projected,
            filename = "/nfs/agfrontiers-data/luc_model/brazil_3_projected_map.tif",
            format = "GTiff",
            overwrite = TRUE,
            options = c("INTERLEAVE=BAND","COMPRESS=LZW"))

### Plot 
# my_col = c('darkgoldenrod1','darkgreen','beige','red', 'blue', 'cyan')
plot(j_m3_projected, legend = FALSE, col = my_col)
legend(x = 'bottomleft', legend = c("Ag", "Forest", "Bare", "Urban", "Water", "Wetlands"), 
       fill = my_col)

```

#### Model 4
```{r}
### Open stacked raster
j_m4 <- raster("/nfs/agfrontiers-data/luc_model/brazil_m4_stacked_all.tif")

### Restrict to JNF
j_m4 <- crop(j_m4, jaman)
j_m4 <- mask(j_m4, jaman)

### Convert to df
j_m4_df <- as.data.frame(j_m4)

### To vector
j_m4_df <- dplyr::pull(j_m4_df, brazil_m4_stacked_all)

### Descending order
j_m4_df <- sort(j_m4_df, decreasing = TRUE)

### Get top values
j_m4_top <- head(j_m4_df, 355178)

### Get range of those values
range(j_m4_top)
### 339-999

### So if the value is >= 339, it converts to agriculture

### Stack 2018 jaman and PP 
j_m4_stack <- stack(jaman_18, j_m4)

### Reclassification function
rc_m4 <- function(x1, x2) {
  ifelse((x1 == 2 & x2 >= 339), 1, x1)
}

## Make output raster
j_m4_projected <- overlay(j_m4_stack, fun = rc_m4)
  
### Save raster
writeRaster(j_m4_projected,
            filename = "/nfs/agfrontiers-data/luc_model/brazil_4_projected_map.tif",
            format = "GTiff",
            overwrite = TRUE,
            options = c("INTERLEAVE=BAND","COMPRESS=LZW"))

### Plot 
# my_col = c('darkgoldenrod1','darkgreen','beige','red', 'blue', 'cyan')
plot(j_m4_projected, legend = FALSE, col = my_col)
legend(x = 'bottomleft', legend = c("Ag", "Forest", "Bare", "Urban", "Water", "Wetlands"), 
       fill = my_col)

```
## Compare JNF model projections
```{r}
### Open model rasters
j1 <- raster("/nfs/agfrontiers-data/luc_model/brazil_1_projected_map.tif")
j2 <- raster("/nfs/agfrontiers-data/luc_model/brazil_2_projected_map.tif")
j3 <- raster("/nfs/agfrontiers-data/luc_model/brazil_3_projected_map.tif")
j4 <- raster("/nfs/agfrontiers-data/luc_model/brazil_4_projected_map.tif")

### Make reclassification matrix
reclass_df <- c(0, 0.99, NA,
                0.991, 1.001, 1,
                1.9, 7.1, 0)
reclass_m <- matrix(reclass_df,
                    ncol = 3,
                    byrow = TRUE)

### Reclassify rasters
j1 <- reclassify(j1,
                 reclass_m)
j2 <- reclassify(j2,
                 reclass_m)
j3 <- reclassify(j3,
                 reclass_m)
j4 <- reclassify(j4,
                 reclass_m)

### Stack files
j_all <- stack(j1, j2, j3, j4)

### Sum
j_summ <- calc(j_all, sum)

### Open 2008 and 2018 LC maps
### Open brazil 2008 map
bra_2008 <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/classi_bra_dry_2008_102033.tif")
### Open brazil 2018 map
bra_2018 <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/classi_bra_dry_2018_102033.tif")
### Open JNF without buffer
jaman <- st_read("/nfs/agfrontiers-data/Case Study Info/Brazil/JamanBuffer/jamanxim_wdpa_march21_102033.shp")
### Crop LUC maps
jaman_08 <- crop(bra_2008, jaman)
jaman_08 <- mask(jaman_08, jaman)
jaman_18 <- crop(bra_2018, jaman)
jaman_18 <- mask(jaman_18, jaman)

### Mask cells that were ag in 2018
j_summ_mask_18 <- mask(j_summ, jaman_18,
                       inverse= FALSE,
                       maskvalue = 1,
                       updatevalue = 10)
### 10 = ag in 2018
### 1 = ag in 2028

### Mask cells that were ag in 2008
j_summ_mask_08 <- mask(j_summ_mask_18, jaman_08,
                       inverse= FALSE,
                       maskvalue = 1,
                       updatevalue = 20)
### 10 = ag in 2018
### 1 = ag in 2028
### 20 = forest in 2008

### Get frequency of each value
ag_2008 <- freq(j_summ_mask_08, value = 20) ## 425969
ag_2018 <- freq(j_summ_mask_08, value = 10) ## 479711
ag_2028_1 <- freq(j_summ_mask_08, value = 1) ## 218706
ag_2028_2 <- freq(j_summ_mask_08, value = 2) ## 26583
ag_2028_3 <- freq(j_summ_mask_08, value = 3) ## 205289
ag_2028_4 <- freq(j_summ_mask_08, value = 4) ## 100305

my_col = c('gray81','olivedrab','steelblue','mediumorchid4', 
           'firebrick1', 'darkgoldenrod1', 'darkorange')

my_col = c('olivedrab',
           'firebrick1',
           'darkgoldenrod1',
           'mediumorchid4', 
           'steelblue', 
           'gray81', 
           'darkorange')

plot(j_summ_mask_08, legend = FALSE, 
     col = c('gray81','olivedrab','steelblue','mediumorchid4', 
           'firebrick1', 'darkgoldenrod1', 'darkorange'))
legend(x = 'bottomleft', 
       legend = c("Not Ag", "1 Model", "2 Models", 
                  "3 Models", "4 Models", "Ag in 2018", 
                  "Ag in 2008"),
       fill = c('gray81','olivedrab','steelblue','mediumorchid4', 
                'firebrick1', 'darkgoldenrod1', 'darkorange'))
```
### Ag over time for models
```{r}
### Open 2008 and 2018 LC maps
### Open brazil 2008 map
bra_2008 <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/classi_bra_dry_2008_102033.tif")
### Open brazil 2018 map
bra_2018 <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/classi_bra_dry_2018_102033.tif")
### Open JNF without buffer
jaman <- st_read("/nfs/agfrontiers-data/Case Study Info/Brazil/JamanBuffer/jamanxim_wdpa_march21_102033.shp")

### Crop LUC maps
jaman_08 <- crop(bra_2008, jaman)
jaman_08 <- mask(jaman_08, jaman)
jaman_18 <- crop(bra_2018, jaman)
jaman_18 <- mask(jaman_18, jaman)
```

#### model 1
```{r}
### Open model rasters
j1 <- raster("/nfs/agfrontiers-data/luc_model/brazil_1_projected_map.tif")

### Mask cells that were ag in 2018
j1_mask_18 <- mask(j1, jaman_18,
                  inverse= FALSE,
                  maskvalue = 1,
                  updatevalue = 10)
### 10 = ag in 2018
### 1 = ag in 2028

### Mask cells that were ag in 2008
j1_mask_08 <- mask(j1_mask_18, jaman_08,
                   inverse= FALSE,
                   maskvalue = 1,
                   updatevalue = 20)
### 10 = ag in 2018
### 1 = ag in 2028
### 20 = ag in 2008

### Get frequency of each value
j1_ag_2008 <- freq(j1_mask_08, value = 20) ## 425969
j1_ag_2018 <- freq(j1_mask_08, value = 10) ## 479711
j1_ag_2028 <- freq(j1_mask_08, value = 1) ## 302344

### Save raster
writeRaster(j1_mask_08,
            filename = "/nfs/agfrontiers-data/luc_model/brazil_1_projected_masked_map.tif",
            format = "GTiff",
            overwrite = TRUE,
            options = c("INTERLEAVE=BAND","COMPRESS=LZW"))
```

#### model 2
```{r}
### Open model rasters
j2 <- raster("/nfs/agfrontiers-data/luc_model/brazil_2_projected_map.tif")

### Mask cells that were ag in 2018
j2_mask_18 <- mask(j2, jaman_18,
                  inverse= FALSE,
                  maskvalue = 1,
                  updatevalue = 10)
### 10 = ag in 2018
### 1 = ag in 2028

### Mask cells that were ag in 2008
j2_mask_08 <- mask(j2_mask_18, jaman_08,
                   inverse= FALSE,
                   maskvalue = 1,
                   updatevalue = 20)
### 10 = ag in 2018
### 1 = ag in 2028
### 20 = forest in 2008

### Get frequency of each value
j2_ag_2008 <- freq(j2_mask_08, value = 20) ## 425969
j2_ag_2018 <- freq(j2_mask_08, value = 10) ## 479711
j2_ag_2028 <- freq(j2_mask_08, value = 1) ## 345180

### Save raster
writeRaster(j2_mask_08,
            filename = "/nfs/agfrontiers-data/luc_model/brazil_2_projected_masked_map.tif",
            format = "GTiff",
            overwrite = TRUE,
            options = c("INTERLEAVE=BAND","COMPRESS=LZW"))
```
#### model 3
```{r}
### Open model rasters
j3 <- raster("/nfs/agfrontiers-data/luc_model/brazil_3_projected_map.tif")

### Mask cells that were ag in 2018
j3_mask_18 <- mask(j3, jaman_18,
                  inverse= FALSE,
                  maskvalue = 1,
                  updatevalue = 10)
### 10 = ag in 2018
### 1 = ag in 2028

### Mask cells that were ag in 2008
j3_mask_08 <- mask(j3_mask_18, jaman_08,
                   inverse= FALSE,
                   maskvalue = 1,
                   updatevalue = 20)
### 10 = ag in 2018
### 1 = ag in 2028
### 20 = forest in 2008

### Get frequency of each value
j3_ag_2008 <- freq(j3_mask_08, value = 20) ## 425969
j3_ag_2018 <- freq(j3_mask_08, value = 10) ## 479711
j3_ag_2028 <- freq(j3_mask_08, value = 1) ## 320573

### Save raster
writeRaster(j3_mask_08,
            filename = "/nfs/agfrontiers-data/luc_model/brazil_3_projected_masked_map.tif",
            format = "GTiff",
            overwrite = TRUE,
            options = c("INTERLEAVE=BAND","COMPRESS=LZW"))
```

#### model 4
```{r}
### Open model rasters
j4 <- raster("/nfs/agfrontiers-data/luc_model/brazil_4_projected_map.tif")

### Mask cells that were ag in 2018
j4_mask_18 <- mask(j4, jaman_18,
                  inverse= FALSE,
                  maskvalue = 1,
                  updatevalue = 10)
### 10 = ag in 2018
### 1 = ag in 2028

### Mask cells that were ag in 2008
j4_mask_08 <- mask(j4_mask_18, jaman_08,
                   inverse= FALSE,
                   maskvalue = 1,
                   updatevalue = 20)
### 10 = ag in 2018
### 1 = ag in 2028
### 20 = forest in 2008

### Get frequency of each value
j4_ag_2008 <- freq(j4_mask_08, value = 20) ## 425969
j4_ag_2018 <- freq(j4_mask_08, value = 10) ## 479711
j4_ag_2028 <- freq(j4_mask_08, value = 1) ## 320862

### Save raster
writeRaster(j4_mask_08,
            filename = "/nfs/agfrontiers-data/luc_model/brazil_4_projected_masked_map.tif",
            format = "GTiff",
            overwrite = TRUE,
            options = c("INTERLEAVE=BAND","COMPRESS=LZW"))
```
#### Area converted per model
```{r}
j1_area <- j1_ag_2028 * res(j1)[1] * res(j1)[2] / 1000000 ## 272.0021 km2
j2_area <- j2_ag_2028 * res(j2)[1] * res(j2)[2] / 1000000 ## 310.5393 km2
j3_area <- j3_ag_2028 * res(j3)[1] * res(j3)[2] / 1000000 ## 288.4017 km2
j4_area <- j4_ag_2028 * res(j4)[1] * res(j4)[2] / 1000000 ## 288.6617 km2

### Make df
area_conv_km2 <- c(272.0021, 310.5393, 288.4017, 288.6617)
model_name <- c("LUC", "DA", "LUC & DA", "Refined LUC & DA")
conv_mod <- data.frame(cbind(model = model_name,
                             area_conv = area_conv_km2))
conv_mod$area_conv <- as.integer(conv_mod$area_conv)

### Make bargraph
conv_mod %>%
  ggplot(aes(x = model, y = area_conv, color = model, fill = model)) +
  geom_bar(stat = "identity") +
  xlab("Model") +
  ylab("Area converted to ag, 2018-2028 (sq. km)") +
  scale_color_brewer(palette = "Dark2") + 
  scale_fill_brewer(palette = "Dark2") + 
  theme_bw(base_size=15) +
  NULL


ggplot(all_models_jnf, aes(x = value_km2, color = Model)) +
  geom_density() +
  xlab("Square km of forest converted to agriculture, 2018-2028") +
  ylab("Density") + 
  theme_bw(base_size=15) +
  scale_color_brewer(palette = "Dark2") + 
  NULL
```
## Graph model coefficients
```{r}
### Open Model 4 coefficients
m4 <- read.csv("/nfs/agfrontiers-data/luc_model/fit_bra_model4.csv")
colnames(m4) <- c("variable", "coefficient", 
                  "std_error", "zvalue", "pvalue")

### Filter out intercept and add model number
m4 <- m4 %>%
  filter(pvalue <= 0.05) %>%
  filter(variable != "(Intercept)") %>%
  mutate(model = "Model 4")

### Rename cols
m4$variable[m4$variable == "soil"] <- "Soil moisture"
m4$variable[m4$variable == "slope"] <- "Slope"
m4$variable[m4$variable == "elev"] <- "Elevation"
m4$variable[m4$variable == "roads"] <- "Dist. to roads"
m4$variable[m4$variable == "cities"] <- "Dist. to cities"
m4$variable[m4$variable == "dist_ag"] <- "Dist. to agriculture"
m4$variable[m4$variable == "dist_fires"] <- "Dist. to fires"
m4$variable[m4$variable == "perc_diff"] <- "Neighborhood effect"
m4$variable[m4$variable == "prot_status10"] <- "10 km buffer"
m4$variable[m4$variable == "prot_status20"] <- "20 km buffer"
m4$variable[m4$variable == "paddd1"] <- "PADDD proposal"
m4$variable[m4$variable == "non_all_land"] <- "% non-allocated land"
m4$variable[m4$variable == "fire_dens"] <- "Fire density"
m4$variable[m4$variable == "agref_sett1"] <- "Ag reform settlement"

### order
m4 <- m4 %>%
  arrange(coefficient)

### Plot
m4 %>%
  arrange(coefficient) %>%
  mutate(name=factor(variable, levels=variable)) %>%
  ggplot(aes(x = coefficient, y = variable)) +
  geom_point(colour = "turquoise4") +
  geom_vline(xintercept = 0, 
             linetype = "dashed", 
             color = "gray") +
  theme(legend.position="none") +
  xlab("Coefficient estimate") + ylab("Variable") +
  NULL
```

## FRAGSTATS
### Model 1
```{r}
### Open files
j1 <- raster("/nfs/agfrontiers-data/luc_model/brazil_1_projected_map.tif")

### Check that it will work
check_landscape(j1) ## it will work

### Reclassification matrix
reclass_df <- c(0, 1.99, 0,
                1.991, 2.001, 1,
                2.1, 7.1, 0)
reclass_m <- matrix(reclass_df,
                    ncol = 3,
                    byrow = TRUE)

### Reclassify rasters
j1 <- reclassify(j1,
                 reclass_m)

### Calculate metrics!

### mean patch area
j1_metrics <- dplyr::bind_rows(
  lsm_l_area_mn(j1, directions = 8),
  lsm_l_area_sd(j1, directions = 8),
  lsm_l_cai_mn(j1, directions = 8),
  lsm_l_cai_sd(j1, directions = 8),
  lsm_l_core_mn(j1, directions = 8),
  lsm_l_core_sd(j1, directions = 8),
  lsm_l_division(j1, directions = 8),
  lsm_l_np(j1, directions = 8),
  lsm_l_pafrac(j1, directions = 8),
  lsm_l_para_mn(j1, directions = 8),
  lsm_l_para_sd(j1, directions = 8),
  lsm_l_tca(j1, directions = 8, 
            consider_boundary = TRUE),
  lsm_l_te(j1, count_boundary = FALSE)
)

### Add column for model
j1_metrics <- j1_metrics %>%
  mutate(model_name = "model1")
```

### Model 2
```{r}
### Open files
j2 <- raster("/nfs/agfrontiers-data/luc_model/brazil_2_projected_map.tif")

### Reclassify rasters
j2 <- reclassify(j2,
                 reclass_m)

### Calculate metrics!

### mean patch area
j2_metrics <- dplyr::bind_rows(
  lsm_l_area_mn(j2, directions = 8),
  lsm_l_area_sd(j2, directions = 8),
  lsm_l_cai_mn(j2, directions = 8),
  lsm_l_cai_sd(j2, directions = 8),
  lsm_l_core_mn(j2, directions = 8),
  lsm_l_core_sd(j2, directions = 8),
  lsm_l_division(j2, directions = 8),
  lsm_l_np(j2, directions = 8),
  lsm_l_pafrac(j2, directions = 8),
  lsm_l_para_mn(j2, directions = 8),
  lsm_l_para_sd(j2, directions = 8),
  lsm_l_tca(j2, directions = 8, 
            consider_boundary = TRUE),
  lsm_l_te(j2, count_boundary = FALSE)
)

### Add column for model
j2_metrics <- j2_metrics %>%
  mutate(model_name = "model2")
```

### Model 3
```{r}
### Open files
j3 <- raster("/nfs/agfrontiers-data/luc_model/brazil_3_projected_map.tif")

### Reclassify rasters
j3 <- reclassify(j3,
                 reclass_m)

### Calculate metrics!

### mean patch area
j3_metrics <- dplyr::bind_rows(
  lsm_l_area_mn(j3, directions = 8),
  lsm_l_area_sd(j3, directions = 8),
  lsm_l_cai_mn(j3, directions = 8),
  lsm_l_cai_sd(j3, directions = 8),
  lsm_l_core_mn(j3, directions = 8),
  lsm_l_core_sd(j3, directions = 8),
  lsm_l_division(j3, directions = 8),
  lsm_l_np(j3, directions = 8),
  lsm_l_pafrac(j3, directions = 8),
  lsm_l_para_mn(j3, directions = 8),
  lsm_l_para_sd(j3, directions = 8),
  lsm_l_tca(j3, directions = 8, 
            consider_boundary = TRUE),
  lsm_l_te(j3, count_boundary = FALSE)
)

### Add column for model
j3_metrics <- j3_metrics %>%
  mutate(model_name = "model3")
```

### Model 4
```{r}
### Open files
j4 <- raster("/nfs/agfrontiers-data/luc_model/brazil_4_projected_map.tif")

### Reclassify rasters
j4 <- reclassify(j4,
                 reclass_m)

### Calculate metrics!

### mean patch area
j4_metrics <- dplyr::bind_rows(
  lsm_l_area_mn(j4, directions = 8),
  lsm_l_area_sd(j4, directions = 8),
  lsm_l_cai_mn(j4, directions = 8),
  lsm_l_cai_sd(j4, directions = 8),
  lsm_l_core_mn(j4, directions = 8),
  lsm_l_core_sd(j4, directions = 8),
  lsm_l_division(j4, directions = 8),
  lsm_l_np(j4, directions = 8),
  lsm_l_pafrac(j4, directions = 8),
  lsm_l_para_mn(j4, directions = 8),
  lsm_l_para_sd(j4, directions = 8),
  lsm_l_tca(j4, directions = 8, 
            consider_boundary = TRUE),
  lsm_l_te(j4, count_boundary = FALSE)
)

### Add column for model
j4_metrics <- j4_metrics %>%
  mutate(model_name = "model4")
```

### 2008 land cover
```{r}
### Reclassify rasters
jaman_08_rc <- reclassify(jaman_08,
                          reclass_m)

### Calculate metrics!

### mean patch area
j_08_metrics <- dplyr::bind_rows(
  lsm_l_area_mn(jaman_08_rc, directions = 8),
  lsm_l_area_sd(jaman_08_rc, directions = 8),
  lsm_l_cai_mn(jaman_08_rc, directions = 8),
  lsm_l_cai_sd(jaman_08_rc, directions = 8),
  lsm_l_core_mn(jaman_08_rc, directions = 8),
  lsm_l_core_sd(jaman_08_rc, directions = 8),
  lsm_l_division(jaman_08_rc, directions = 8),
  lsm_l_np(jaman_08_rc, directions = 8),
  lsm_l_pafrac(jaman_08_rc, directions = 8),
  lsm_l_para_mn(jaman_08_rc, directions = 8),
  lsm_l_para_sd(jaman_08_rc, directions = 8),
  lsm_l_tca(jaman_08_rc, directions = 8, 
            consider_boundary = TRUE),
  lsm_l_te(jaman_08_rc, count_boundary = FALSE)
)

### Add column for model
j_08_metrics <- j_08_metrics %>%
  mutate(model_name = "jamanxim_2008")
```

### 2018 land cover
```{r}
### Reclassify rasters
jaman_18_rc <- reclassify(jaman_18,
                          reclass_m)

### Calculate metrics!

### mean patch area
j_18_metrics <- dplyr::bind_rows(
  lsm_l_area_mn(jaman_18_rc, directions = 8),
  lsm_l_area_sd(jaman_18_rc, directions = 8),
  lsm_l_cai_mn(jaman_18_rc, directions = 8),
  lsm_l_cai_sd(jaman_18_rc, directions = 8),
  lsm_l_core_mn(jaman_18_rc, directions = 8),
  lsm_l_core_sd(jaman_18_rc, directions = 8),
  lsm_l_division(jaman_18_rc, directions = 8),
  lsm_l_np(jaman_18_rc, directions = 8),
  lsm_l_pafrac(jaman_18_rc, directions = 8),
  lsm_l_para_mn(jaman_18_rc, directions = 8),
  lsm_l_para_sd(jaman_18_rc, directions = 8),
  lsm_l_tca(jaman_18_rc, directions = 8, 
            consider_boundary = TRUE),
  lsm_l_te(jaman_18_rc, count_boundary = FALSE)
)

### Add column for model
j_18_metrics <- j_18_metrics %>%
  mutate(model_name = "jamanxim_2018")
```

### Combine
```{r}
### One df
all_metrics <- rbind(j1_metrics,
                     j2_metrics,
                     j3_metrics,
                     j4_metrics,
                     j_08_metrics,
                     j_18_metrics)

### Write csv
write_csv(all_metrics,
          "/nfs/agfrontiers-data/luc_model/brazil_landscape_metrics.tif")
```

