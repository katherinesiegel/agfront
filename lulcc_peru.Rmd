---
title: "lulcc_peru"
output: html_document
---
## Description
Play with LUC models in Brazil

## Set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

### Open packages
library(tidyverse)
library(sf)
library(raster)
library(sp)
library(rgdal)
# library(lulcc)
# library(gsubfn)
# library(caret)

#### Function to check correlation
cor.prob <- function (X, dfr = nrow(X) - 2) {
  R <- cor(X, use="pairwise.complete.obs")
  above <- row(R) < col(R)
  r2 <- R[above]^2
  Fstat <- r2 * dfr/(1 - r2)
  R[above] <- 1 - pf(Fstat, 1, dfr)
  R[row(R) == col(R)] <- NA
  R
}
flattenSquareMatrix <- function(m) {
  if( (class(m) != "matrix") | (nrow(m) != ncol(m))) stop("Must be a square matrix.") 
  if(!identical(rownames(m), colnames(m))) stop("Row and column names must be equal.")
  ut <- upper.tri(m)
  data.frame(i = rownames(m)[row(m)[ut]],
             j = rownames(m)[col(m)[ut]],
             cor=t(m)[ut],
             p=m[ut])
}
```

## Transition change prob
```{r}
### Peru
### Open rasters
per08 <- raster("/nfs/agfrontiers-data/Remote Sensing/classified_layers/Classified_SR/PER/classi_PER_dry_2008.tif")
per18 <- raster("/nfs/agfrontiers-data/Remote Sensing/classified_layers/Classified_SR/PER/classi_PER_dry_2018.tif")

### Change
luc <- data.frame(lc08 = values(per08),
                  lc18 = values(per18))

### Raw tally matrix of change
mat <- table(luc[, c('lc08', 'lc18')])

### See as table
# kable(mat, format = "pandoc", caption = "Counts of land cover/use changes from 2018 (rows) to 2018 (columns)")

### Calculate probabilities
p_mat <- as.matrix(mat/rowSums(mat))
p_mat <- round(p_mat, 3)
# kable(p_mat, format = "pandoc", caption = "Transition probability matrix of land cover/use changes from 2018 (rows) to 2018 (columns)")
p_mat_df <- as.data.frame(p_mat)
write.csv(p_mat_df, 
          "/nfs/agfrontiers-data/luc_model/peru_luc_matrix.csv")
```

## Sample on grid
```{r}
### Open buffer polygon
per_buff <- st_read("/nfs/agfrontiers-data/Case Study Info/peru_buff_final.shp") %>%
  st_transform(., crs = "+proj=aea +lat_0=-32 +lon_0=-60 +lat_1=-5 +lat_2=-42 +x_0=0 +y_0=0
+ellps=aust_SA +units=m +no_defs")

### Make sampling grid, point every 1 km
per_samples <- per_buff %>%
  
  ### Make samples (every 300 m)
  st_make_grid(cellsize = c(300, 300),
               what = "centers") %>%
  
  ### Convert to sf
  st_sf() %>%
  
  ### Add identifiers
  mutate(lon = st_coordinates(.)[, 1],
         lat = st_coordinates(.)[, 2])

### Add UID
per_samples$uid <- 1:nrow(per_samples)

### Open brazil 2008 map
per_2008 <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/classi_per_dry_2008_102033.tif")

### Extract land cover type to sample points
per_samples_2008 <- raster::extract(per_2008, 
                                    per_samples, 
                                    df = TRUE)

### See how many were forest in 2008
p_2008_summ <- per_samples_2008 %>%
  group_by(classi_per_dry_2008_102033) %>%
  summarise(n_per_class = n())
### 0 = no data, 1 = agriculture, 2 = forest, 3 = bare soil, 4 = urban, 5 = wetland, 6 = desert, and 7 = water
### 246146 forested points in 2008

### Add uid back in
per_samples_2008$uid <- per_samples$uid

### Merge bra_samples_2008 with bra_samples
per_samples <- merge(per_samples, 
                     per_samples_2008,
                     by = "uid")
rm(per_samples_2008)

### Subset to forested points
per_forest_samp <- per_samples %>%
  subset(classi_per_dry_2008_102033 == "2")

### Rename cols
per_forest_samp <- per_forest_samp %>%
  dplyr::select(uid, lon, lat, 
                lc_2008 = classi_per_dry_2008_102033)

### Open peru 2018 map
per_2018 <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/classi_per_dry_2018_102033.tif")

### Extract 2018 land cover class
luc_per <- raster::extract(per_2018, 
                           per_forest_samp, 
                           df = TRUE)

### Add UID and merge with sf
luc_per$uid <- per_forest_samp$uid
luc_per <- merge(per_forest_samp, 
                 luc_per,
                 by = "uid")

### Rename cols
luc_per <- luc_per %>%
  dplyr::select(uid, lon, lat, 
                lc_2008,
                lc_2018 = classi_per_dry_2018_102033,
                geometry)

### Write out sample pts
st_write(luc_per,
         "/nfs/agfrontiers-data/luc_model/per_sample_pts.shp")

### Summarize transitions
luc_per_summ <- luc_per %>%
  group_by(lc_2018) %>%
  summarise(n_transitions = n())
luc_per_summ <- luc_per_summ %>%
  mutate(portion_pts = n_transitions/246146*100)

### 99.7% of forested points remained in forest cover
### 0.13% converted from forest to ag
### 0.07% converted from forest to bare soil
### 0.02% converted from forest to urban
### <0.01% converted from forest to wetland or desert
### 0.10% converted from forest to water

### Drop intermediate dfs/rasters
rm(per_2008, per_2018, per_buff, per_samples)
```

### Extract neighborhood values to pts
```{r}
### Open sample pts
per_pts <- st_read("/nfs/agfrontiers-data/luc_model/per_sample_pts.shp")

### Open brazil neighbor pts raster
per_neigh <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/per_perc_diff.tif")

### Extract neighborhood pixel values to brazil pts
per_neigh_dat <- extract(per_neigh, 
                         per_pts,
                         df = TRUE)

### Give it a uid
per_neigh_dat$uid <- per_pts$uid

### Merge with sf
per_neigh_dat <- merge(per_pts,
                       per_neigh_dat,
                       by = "uid")

### Write it out
st_write(per_neigh_dat,
         "/nfs/agfrontiers-data/luc_model/per_forest_neighs.shp")
```

### UIDs of points with complete data
```{r}
# ### Open sample points
# luc_bra <- st_read("D:/dinamica/sample_pts_model/bra_forest.shp")
# 
### Open rasterbrick, all layers
# bra_layers_all <- brick("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/brazil_all_layers.tif")
per_layers_all <- brick("/nfs/agfrontiers-data/luc_model/peru_all_layers.tif")

### Replace precip layer
per_layers_all <- dropLayer(per_layers_all, 9)

### Open new precip layer
per_precip <- raster("/nfs/agfrontiers-data/luc_model/per_precip_new.tif")

### Add new precip layer
per_layers_all <- addLayer(per_layers_all, per_precip)

### Extract values to pts
per_dat_all <- extract(per_layers_all, 
                       per_neigh_dat,
                       df = TRUE)

### Rename columns
colnames(per_dat_all) <- c("id", "aspect", "cities",
                           "crop_suit", "elev",
                           "mines", "prot_status",
                           "popdens", "poverty",
                           "rivers",
                           "roads", "slope",
                           "soil", "dist_ag",
                           "control", "commun",
                           "fire", "forest",
                           "illegal_mines", "minconc",
                           "nonforconc", "npchg",
                           "permprod", "protforest",
                           "refor", "tourism",
                           "precip")

### Give it a uid
per_dat_all$uid <- luc_per$uid

### Merge with sf
per_dat_all <- merge(luc_per,
                     per_dat_all,
                     by = "uid")

### Version without geometry
per_dat_all_simp <- per_dat_all
per_dat_all_simp$geometry <- NULL

### Drop incomplete rows
per_dat_all_simp <- per_dat_all_simp[complete.cases(per_dat_all_simp), ]

### Drop rows where prot_status = 0 (??)
per_dat_all_simp <- per_dat_all_simp %>%
  filter(., !prot_status == "0")

### Get uids
uid_comp <- per_dat_all_simp$uid

### Add geom back to visualize
per_dat_all <- per_dat_all %>%
  filter(uid %in% uid_comp)

### Write out sample pts
st_write(per_dat_all,
         "/nfs/agfrontiers-data/luc_model/peru_f_data.shp",
         append = FALSE)
```

#### Combine with neighbor pix values
```{r}
### Open brazil_f_data
per_data <- st_read("/nfs/agfrontiers-data/luc_model/peru_f_data.shp")

### Fix col names
colnames(per_data) <- c("uid", "lon", "lat", "lc_2008", "lc_2018",
                        "id", "aspect", "cities",
                        "crop_suit", "elev",
                        "mines", "prot_status",
                        "popdens", "poverty",
                        "rivers",
                        "roads", "slope",
                        "soil", "dist_ag",
                        "control", "commun",
                        "fire", "forest",
                        "illegal_mines", "minconc",
                        "nonforconc", "npchg",
                        "permprod", "protforest",
                        "refor", "tourism", "precip", "geometry")

per_neigh_dat <- per_neigh_dat %>%
  dplyr::select(uid, lon, lat, lc_2008, lc_2018, perc_diff = per_perc_diff, geometry)

### Versions wo geometry
per_data_df <- per_data
st_geometry(per_data_df) <- NULL
per_neigh_df <- per_neigh_dat
st_geometry(per_neigh_df) <- NULL

### Merge with neighbors
per_dat_all <- merge(per_data_df, per_neigh_df,
                     by = c("uid", "lon", "lat", "lc_2008", "lc_2018"),
                     all.x = TRUE)

### Write out sample pts
write_csv(per_dat_all,
         "/nfs/agfrontiers-data/luc_model/peru_data_for_model.csv")
```

#### Add factor cols
```{r}
# ### Open file
# per_dat_all <- st_read("D:/dinamica/sample_pts_model/peru_f_data.shp")

### Make column for transition/none
per_dat_all <- per_dat_all %>%
  mutate(transition = ifelse(lc_2018 == "2",
                             "no_change",
                             ifelse(lc_2018 == "1",
                                    "f_to_ag", 
                                    "other_change")),
         trans_rc = ifelse(transition == "no_change",
                           "0", ifelse(transition == "f_to_ag",
                                       "1", "2")))

### Make columns factor
fact_cols <- c("uid", "prot_status", 
               "minconc",
               "nonforconc", "npchg",
               "permprod", "protforest",
               "refor",
               "lc_2018", "trans_rc")
per_dat_all <- per_dat_all %>%
  mutate_each_(funs(factor(.)), fact_cols)
```

### Check correlations 
Restrict to points that did not change or points that converted to ag
```{r}
### Restrict to transitions
per_dat_use <- per_dat_all %>% 
  filter(trans_rc == "1" | trans_rc == "0")

### Make corr table
cor_table_per <- flattenSquareMatrix(cor.prob(per_dat_use[, c(2, 3, 7:11, 13:24, 31:33)]))

### Look at vars with abs(cor.prob) > 0.66 and pvalue < 0.05
cor_table_per <- subset(cor_table_per, 
                        abs(cor) > 0.66 & p <= 0.05)

### Distance to cities and distance to mines: 0.8203093
### Distance to cities and distance to illegal mines: 0.8900793
### Distance to control and distance to communities: 0.9332728
### Elevation and slope: 0.7811272
### Elevation and soil moisture: 0.7092253
### Elevation and distance to control: 0.6658433
### Elevation and distance to community: 0.7105915
### Distance to forest and % different neighboring pixels: 0.7406924
### Latitude and crop suitability: 0.7094246
### Latitude and elevation: -0.7866532
### Latitude and population density: -0.7217329
### Latitude and poverty: -0.7925621
### Latitude and slope: -0.7032233
### Latitude and soil moisture: -0.7694424
### Latitude and distance to control: -0.8068978
### Latitude and distance to community: -0.8402947
### Longitude and precip: -0.7432180
### Distance to mines and distance to illegal mines: 0.9103678
### Pop density and poverty: 0.9440444
### Poverty and distance to control: 0.6704473
### Poverty and distance to community: 0.7688669
### Distance to rivers and distance to roads: 1.0000000
### Slope and soil moisture: 0.7097560
```

### Model 1
Standard LUC variables only

#### Regression
```{r}
### Variables to drop due to correlations:
### latitude, longitude (dropped because don't have mechanism)
### elev, soil, roads, mines

### Run regression
fit_per <- glm(trans_rc ~ aspect + cities + 
                 slope + 
                 crop_suit + prot_status + popdens + 
                 precip + rivers + dist_ag + perc_diff,
               data = per_dat_use,
               family = binomial(link = "logit"))

### Write out coefficients
fit_per_summ <- summary(fit_per)
fit_per_coeff <- as.data.frame(fit_per_summ$coefficients)
write.csv(fit_per_coeff, 
          file = "/nfs/agfrontiers-data/luc_model/fit_per_model1.csv")
```

### Model 2
Discourse analysis variables only:
* dist_ag
* Indigenous communities (dropped because correlated with distance to control posts)
* distance to control posts
* distance to fires
* illegal mines
* REDD concessions and protected forests
* tourism

```{r}
### Run regression
fit_per_m2 <- glm(trans_rc ~ dist_ag +
                    control + fire + illegal_mines +
                    nonforconc + npchg + permprod + protforest +
                    refor + tourism,
                  data = per_dat_use,
                  family = binomial(link = "logit"))

### Write out coefficients
fit_per2_summ <- summary(fit_per_m2)
fit_per2_coeff <- as.data.frame(fit_per2_summ$coefficients)
write.csv(fit_per2_coeff, 
          file = "/nfs/agfrontiers-data/luc_model/fit_per_model2.csv")
```

### Model 3
All standard variables and discourse analysis variables
```{r}
### Drop due to correlation: distance to cities (correlated with distance to illegal mines)
### Run regression
fit_per_m3 <- glm(trans_rc ~ aspect + slope + 
                    crop_suit + prot_status + popdens + 
                    precip + rivers + dist_ag + perc_diff +
                    control + fire + illegal_mines +
                    nonforconc + npchg + permprod + protforest +
                    refor + tourism,
                  data = per_dat_use,
                  family = binomial(link = "logit"))

### Write out coefficients
fit_per3_summ <- summary(fit_per_m3)
fit_per3_coeff <- as.data.frame(fit_per3_summ$coefficients)
write.csv(fit_per3_coeff, 
          file = "/nfs/agfrontiers-data/luc_model/fit_per_model3.csv")
```

### Model 4
Statistically significant variables from Model 1 + qualitatively significant variables from discourse analysis
Model 1 vars: slope + rivers + dist_ag + crop_suit + popdens + perc_diff + prot_status
Model 2 vars: control (correlated with Indigenous communities), fires, illegal mines, REDD concession, protected forests, tourism
```{r}
### Run regression
fit_per_m4 <- glm(trans_rc ~ slope + rivers + 
                    dist_ag + crop_suit + popdens + 
                    perc_diff + prot_status +
                    control + fire + illegal_mines + 
                    nonforconc + permprod + protforest +
                    refor + tourism,
                  data = per_dat_use,
                  family = binomial(link = "logit"))

### Write out coefficients
fit_per4_summ <- summary(fit_per_m4)
fit_per4_coeff <- as.data.frame(fit_per4_summ$coefficients)
write.csv(fit_per4_coeff, 
          file = "/nfs/agfrontiers-data/luc_model/fit_per_model4.csv")
```

### Compare model performance
```{r}
### AIC
AIC(fit_per, fit_per_m2,
    fit_per_m3, fit_per_m4) ### Model 3 has lowest AIC

### anova
anova(fit_per, fit_per_m2,
      fit_per_m3, fit_per_m4,
      test = "Chisq")
anova(fit_per_m2, fit_per_m3, test = "Chisq") ## 3 better than 2
anova(fit_per_m3, fit_per_m4, test = "Chisq") ## 3 better than 4
anova(fit_per, fit_per_m2, test = "Chisq")
anova(fit_per, fit_per_m4, test = "Chisq") ## 4 better than 1

### psuedo r2
library(pscl)
pR2(fit_per)
pR2(fit_per_m2)
pR2(fit_per_m3)
pR2(fit_per_m4)
```
# ANALYZE MODEL OUTPUT
Analyze outputs from predict_luc_peru.R

## Analyze Monte Carlo simulations for buffer
Output from predict_luc_peru.R
```{r}
### Model 1, whole extent
m1_mc <- read.csv("/nfs/agfrontiers-data/luc_model/peru_1_project/peru_projected_loss.csv")

### Add columns for model and extent
m1_mc <- m1_mc %>%
  mutate(model = "model1",
         extent = "whole_area",
         value_km2 = x/1000000)

### Model 1, Tambo
m1_tambo <- read.csv("/nfs/agfrontiers-data/luc_model/peru_1_project/peru_projected_loss_tambopata.csv")
m1_tambo <- m1_tambo %>%
  mutate(model = "model1",
         extent = "tambopata",
         value_km2 = x/1000000)

### Model 1, B-S
m1_bahua <- read.csv("/nfs/agfrontiers-data/luc_model/peru_1_project/peru_projected_loss_bahuaja.csv")
m1_bahua <- m1_bahua %>%
  mutate(model = "model1",
         extent = "bahuaja_sonene",
         value_km2 = x/1000000)

### Model 2, whole extent
m2_mc <- read.csv("/nfs/agfrontiers-data/luc_model/peru_2_project/peru_2_projected_loss.csv")
### Add columns for model and extent
m2_mc <- m2_mc %>%
  mutate(model = "model2",
         extent = "whole_area",
         value_km2 = x/1000000)

### Model 2, Tambo
m2_tambo <- read.csv("/nfs/agfrontiers-data/luc_model/peru_2_project/peru_2_projected_loss_tambopata.csv")
m2_tambo <- m2_tambo %>%
  mutate(model = "model2",
         extent = "tambopata",
         value_km2 = x/1000000)

### Model 2, B-S
m2_bahua <- read.csv("/nfs/agfrontiers-data/luc_model/peru_2_project/peru_2_projected_loss_bahuaja.csv")
m2_bahua <- m2_bahua %>%
  mutate(model = "model2",
         extent = "bahuaja_sonene",
         value_km2 = x/1000000)

### Model 3, whole extent
m3_mc <- read.csv("/nfs/agfrontiers-data/luc_model/peru_3_project/peru_3_projected_loss.csv")
### Add columns for model and extent
m3_mc <- m3_mc %>%
  mutate(model = "model3",
         extent = "whole_area",
         value_km2 = x/1000000)

### Model 3, Tambo
m3_tambo <- read.csv("/nfs/agfrontiers-data/luc_model/peru_3_project/peru_3_projected_loss_tambopata.csv")
m3_tambo <- m3_tambo %>%
  mutate(model = "model3",
         extent = "tambopata",
         value_km2 = x/1000000)

### Model 3, B-S
m3_bahua <- read.csv("/nfs/agfrontiers-data/luc_model/peru_3_project/peru_3_projected_loss_bahuaja.csv")
m3_bahua <- m3_bahua %>%
  mutate(model = "model3",
         extent = "bahuaja_sonene",
         value_km2 = x/1000000)

### Model 4, whole extent
m4_mc <- read.csv("/nfs/agfrontiers-data/luc_model/peru_4_project/peru_4_projected_loss.csv")
### Add columns for model and extent
m4_mc <- m4_mc %>%
  mutate(model = "model4",
         extent = "whole_area",
         value_km2 = x/1000000)

### Model 4, Tambo
m4_tambo <- read.csv("/nfs/agfrontiers-data/luc_model/peru_4_project/peru_4_projected_loss_tambopata.csv")
m4_tambo <- m4_tambo %>%
  mutate(model = "model4",
         extent = "tambopata",
         value_km2 = x/1000000)

### Model 4, B-S
m4_bahua <- read.csv("/nfs/agfrontiers-data/luc_model/peru_4_project/peru_4_projected_loss_bahuaja.csv")
m4_bahua <- m4_bahua %>%
  mutate(model = "model4",
         extent = "bahuaja_sonene",
         value_km2 = x/1000000)

### Take means and sds of whole extent
mean(m1_tambo$value_km2)
sd(m1_tambo$value_km2)
mean(m2_tambo$value_km2)
sd(m2_tambo$value_km2)
mean(m3_tambo$value_km2)
sd(m3_tambo$value_km2)
mean(m4_tambo$value_km2)
sd(m4_tambo$value_km2)

### Take means and sds of whole extent
mean(m1_bahua$value_km2)
sd(m1_bahua$value_km2)
mean(m2_bahua$value_km2)
sd(m2_bahua$value_km2)
mean(m3_bahua$value_km2)
sd(m3_bahua$value_km2)
mean(m4_bahua$value_km2)
sd(m4_bahua$value_km2)

### Take means and sds of entire extent
mean(m1_mc$value_km2)
sd(m1_mc$value_km2)
mean(m2_mc$value_km2)
sd(m2_mc$value_km2)
mean(m3_mc$value_km2)
sd(m3_mc$value_km2)
mean(m4_mc$value_km2)
sd(m4_mc$value_km2)

### rbind
all_models <- rbind(m1_mc, m2_mc, 
                    m3_mc, m4_mc)
all_model_tambo <- rbind(m1_tambo, m2_tambo,
                         m3_tambo, m4_tambo)
all_model_bs <- rbind(m1_bahua, m2_bahua, 
                      m3_bahua, m4_bahua)

### Plot for full extent
ggplot(all_models, aes(x = value_km2, color = model)) +
  geom_density() +
  xlab("Square km of forest converted to agriculture") +
  ylab("Density")
ggsave("/nfs/agfrontiers-data/luc_model/peru_allmodels_area_defor.png")

### Plot for Tambopata
ggplot(all_model_tambo, aes(x = value_km2, color = model)) +
  geom_density() +
  xlab("Square km of forest converted to agriculture") +
  ylab("Density")
ggsave("/nfs/agfrontiers-data/luc_model/peru_allmodels_area_defor_tambopata.png")

### Plot for Bahuaja-Sonene
ggplot(all_model_bs, aes(x = value_km2, color = model)) +
  geom_density() +
  xlab("Square km of forest converted to agriculture") +
  ylab("Density")
ggsave("/nfs/agfrontiers-data/luc_model/peru_allmodels_area_defor_bahuaja.png")
```
### Observed forest loss, 2008-2018
```{r}
### Whole region
per_2008 <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/classi_per_dry_2008_102033.tif")
per_2018 <- raster("/nfs/agfrontiers-data/Remote Sensing/KS files/classi_per_dry_2018_102033.tif")

### 2008
forest_08 <- as.data.frame(per_2008) %>%
    group_by(classi_per_dry_2008_102033) %>%
    tally() %>%
    mutate(area = n * res(per_2008)[1] * res(per_2008)[2])

### 2018
forest_18 <- as.data.frame(per_2018) %>%
    group_by(classi_per_dry_2018_102033) %>%
    tally() %>%
    mutate(area = n * res(per_2018)[1] * res(per_2018)[2])

### Calculate forested area lost 
f_lost <- (22152369600-22131216000)/1000000
```
#### Observed forest loss w/in parks
```{r}
### Open shps
tambo <- st_read("/nfs/agfrontiers-data/Case Study Info/Peru/wdpa_mar2021_tambo_102033.shp")
bahua <- st_read("/nfs/agfrontiers-data/Case Study Info/Peru/wdpa_mar2021_bahuaja_102033.shp")

### Crop LUC maps
tambo_08 <- crop(per_2008, tambo)
tambo_08 <- mask(tambo_08, tambo)
tambo_18 <- crop(per_2018, tambo)
tambo_18 <- mask(tambo_18, tambo)
bahua_08 <- crop(per_2008, bahua)
bahua_08 <- mask(bahua_08, bahua)
bahua_18 <- crop(per_2018, bahua)
bahua_18 <- mask(bahua_18, bahua)

### Tambopata forest loss
### 2008
forest_08_tambo <- as.data.frame(tambo_08) %>%
    group_by(classi_per_dry_2008_102033) %>%
    tally() %>%
    mutate(area = n * res(tambo_08)[1] * res(tambo_08)[2])

### 2018
forest_18_tambo <- as.data.frame(tambo_18) %>%
    group_by(classi_per_dry_2018_102033) %>%
    tally() %>%
    mutate(area = n * res(tambo_18)[1] * res(tambo_18)[2])

### Calculate forested area lost 
f_lost_tambo <- (2736436500-2733995700)/1000000

### Bahuaja-Sonene forest loss
### 2008
forest_08_bahua <- as.data.frame(bahua_08) %>%
    group_by(classi_per_dry_2008_102033) %>%
    tally() %>%
    mutate(area = n * res(bahua_08)[1] * res(bahua_08)[2])

### 2018
forest_18_bahua <- as.data.frame(bahua_18) %>%
    group_by(classi_per_dry_2018_102033) %>%
    tally() %>%
    mutate(area = n * res(bahua_18)[1] * res(bahua_18)[2])

### Calculate forested area lost 
f_lost_bahua <- (10792656900-10782045900)/1000000
```
## Add Simulations
Add up simulated maps
```{r}
#############
### Model 1
#############
### Open rasters
r1 <- raster("/nfs/agfrontiers-data/luc_model/peru_m1_stacked_1.tif")
r2 <- raster("/nfs/agfrontiers-data/luc_model/peru_m1_stacked_2.tif")
r3 <- raster("/nfs/agfrontiers-data/luc_model/peru_m1_stacked_3.tif")
r4 <- raster("/nfs/agfrontiers-data/luc_model/peru_m1_stacked_4.tif")
r5 <- raster("/nfs/agfrontiers-data/luc_model/peru_m1_stacked_5.tif")

### Stack
r_stack <- stack(r1, r2, r3, r4, r5)

### Add raster values
r_add <- calc(r_stack, sum)

### Save output
writeRaster(r_add, 
            "/nfs/agfrontiers-data/luc_model/peru_m1_stacked_all.tif")

#############
### Model 2
#############
### Open rasters
r1 <- raster("/nfs/agfrontiers-data/luc_model/peru_m2_stacked_1.tif")
r2 <- raster("/nfs/agfrontiers-data/luc_model/peru_m2_stacked_2.tif")
r3 <- raster("/nfs/agfrontiers-data/luc_model/peru_m2_stacked_3.tif")
r4 <- raster("/nfs/agfrontiers-data/luc_model/peru_m2_stacked_4.tif")
r5 <- raster("/nfs/agfrontiers-data/luc_model/peru_m2_stacked_5.tif")

### Stack
r_stack <- stack(r1, r2, r3, r4, r5)

### Add raster values
r_add <- calc(r_stack, sum)

### Save output
writeRaster(r_add, 
            "/nfs/agfrontiers-data/luc_model/peru_m2_stacked_all.tif")

#############
### Model 3
#############
### Open rasters
r1 <- raster("/nfs/agfrontiers-data/luc_model/peru_m3_stacked_1.tif")
r2 <- raster("/nfs/agfrontiers-data/luc_model/peru_m3_stacked_2.tif")
r3 <- raster("/nfs/agfrontiers-data/luc_model/peru_m3_stacked_3.tif")
r4 <- raster("/nfs/agfrontiers-data/luc_model/peru_m3_stacked_4.tif")
r5 <- raster("/nfs/agfrontiers-data/luc_model/peru_m3_stacked_5.tif")

### Stack
r_stack <- stack(r1, r2, r3, r4, r5)

### Add raster values
r_add <- calc(r_stack, sum)

### Save output
writeRaster(r_add, 
            "/nfs/agfrontiers-data/luc_model/peru_m3_stacked_all.tif")

#############
### Model 4
#############
### Open rasters
r1 <- raster("/nfs/agfrontiers-data/luc_model/peru_m4_stacked_1.tif")
r2 <- raster("/nfs/agfrontiers-data/luc_model/peru_m4_stacked_2.tif")
r3 <- raster("/nfs/agfrontiers-data/luc_model/peru_m4_stacked_3.tif")
r4 <- raster("/nfs/agfrontiers-data/luc_model/peru_m4_stacked_4.tif")
r5 <- raster("/nfs/agfrontiers-data/luc_model/peru_m4_stacked_5.tif")

### Stack
r_stack <- stack(r1, r2, r3, r4, r5)

### Add raster values
r_add <- calc(r_stack, sum)

### Save output
writeRaster(r_add, 
            "/nfs/agfrontiers-data/luc_model/peru_m4_stacked_all.tif")
```
