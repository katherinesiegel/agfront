---
title: "brazil_da_layers"
author: "Katherine Siegel"
date: "October 14, 2019"
output: html_document
---

## Description
New layers for Brazil DINAMICA, as identified by discourse analysis

## Set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

### Packages
library(tidyverse)
library(raster)
library(sf)
library(lwgeom)
library(sp)
library(lubridate)
library(rgdal)
# library(stars)
```

## Jamanxim
```{r}
### Open Jamanxim shp
jambuf <- st_read("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/case_study_shp/JamanBuffer/JamanBuffer.shp") %>%
  st_transform(., crs = 102033) # %>%
  # st_write(., "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/case_study_shp/JamanBuffer/JamanBuffer_reproj.shp")

### Make big shp buffer for intersections
jambuf_big <- st_buffer(jambuf, dist = 50000)
# st_write(jambuf_big,
#          "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/case_study_shp/JamanBuffer/jaman_buff_big.shp")

### Make buffer for pepe
jambuf_pepe <- st_buffer(jambuf, dist = 3000)
# st_write(jambuf_pepe,
#          "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/case_study_shp/JamanBuffer/jaman_buff_pepe.shp")

### Open raster
jm_2008 <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/remote_sensing/classi_bra_dry_2008_102033.tif")

### Municipios
braz <- getData("GADM", country = "BRA", level = 2) %>%
  st_as_sf() %>%
  st_transform(., crs = 102033) %>%
  subset(., NAME_1 == "Pará") %>%
  dplyr::select(., state = NAME_1, 
                municipio = NAME_2,
                geometry)

### Muncipios in Jamanxim
munic_jam <- st_intersection(jambuf, braz)

### Make sf of muncipios in Jamanxim
municipios <- braz %>%
  filter(., municipio %in% munic_jam$municipio)

# ### Municipios for cities raster
# municip_cities <- braz <- getData("GADM", country = "BRA", 
#                                   level = 2) %>%
#   st_as_sf() %>%
#   st_transform(., crs = 102033) %>%
#   filter(., NAME_1 %in% c("Pará", "Amazonas", "Mato Grosso")) %>%
#   dplyr::select(., state = NAME_1, 
#                 municipio = NAME_2,
#                 geometry) %>%
#   # st_write(., 
#   #          "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/municip_three_states.shp")
#   filter(., municipio %in% 
#            c("Altamira", "Itaituba", "Novo Progresso",
#              "Trairão", "Jacareacanga", "Rurópolis",
#              "Pacajá", "Uruará", "Medicilândia",
#              "Brazil Novo", "Vitória do Xingu",
#              "Senador José Porfírio", "São Félix do Xingu",
#              "Anapu", "Apuí", "Maués", "Parintins",
#              "Barreirinha", "Boa Vista do Ramos",
#              "Nhamundá", "Urucará", "Urucurituba",
#              "Aripuanã", "Cotriguaçu", "Nova Bandeirantes",
#              "Cotriguaçu", "Apiacás", "Nova Monte Verde",
#              "Paranatinga", "Alta Floresta", "Apiacás",
#              "Carlinda", "Novo Mundo", "Nova Canaã do Norte",
#              "Colíder", "Tabaporã", "Guarantã do Norte",
#              "Jauru", "Novo Horizonte do Norte", 
#              "Porto dos Gaúchos", "Tapurah", "Sinop", "Borba",
#              "Nova Olinda do Norte", "Itaúba",
#              "Terra Nova do Norte", "Peixoto de Azevedo",
#              "Cláudia", "Marcelândia", "Matupá",
#              "Nova Guarita")) %>%
#   st_write(., 
#            "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/municip_region.shp")
```

### Classified rasters
Reprojected all classified rasters to 102033 in QGIS

## Proposed Infrastructure
Coordinates of proposed dams and railroads from Stefano Wrobleski 

### Railroad
Data from http://infraestrutura.gov.br/images/BIT_TESTE/kmz/ferrovias.kmz. Converted kmz to shp in ArcMap (KML to Layer function)
```{r}
### Open shapefile of railroads
rr <- st_read("D:/dinamica/brazil_dinamica_data/proposed_infrastr/ferrovias.shp") %>%
  st_transform(., crs = 102033)

### Make larger Jaman buffer for clipping
jam_big <- st_buffer(jambuf, dist = 50000)

### Intersect roads and jaman buff
rr <- st_intersection(rr, jam_big)

### Write out so can calculate distance raster in Arc
st_write(rr, 
         "D:/dinamica/brazil_dinamica_data/proposed_infrastr/railroads.shp")
st_write(jam_big, "D:/dinamica/brazil_dinamica_data/jaman_bigbuff.shp")

### Set max dist to 138000, export as tif: dist_rr.tif

### Open tif
rr_dist <- raster("D:/dinamica/brazil_dinamica_data/proposed_infrastr/dist_rr.tif")

### Resample to match Jaman raster
rr_resample <- raster::resample(rr_dist, jm_2008, "bilinear")

### Save output raster to folder on ext hard drive
writeRaster(rr_resample,
            filename = "D:/dinamica/brazil_dinamica_data/discourse_analysis_final_layers/bra_dist_proposed_rr.tiff",
            format = "GTiff",
            overwrite = TRUE)
```

### Dams
Data from Agência Nacional de Energia Elétrica:  
* Cachoeira dos Patos: 5d54m59sS 55d45m36sW  
* Jardim de Ouro:  6d15m49sS 55d45m53sW  
* Jamanxim: 5d38m48sS 55d52m38sW
```{r}
# ### Dam vectors
# dam_names <- c("Cachoeira dos Patos", "Jardim de Ouro", "Jamanxim")
# dam_coords <- c("5d54m59r S", "55d45m36r W", 
#                 "6d15m49r S", "55d45m53r W",
#                 "5d38m48r S", "55d52m38r W")
# 
# ### Convert dam_coords to DMS
# dam_coords_dd <- as.numeric(char2dms(from = dam_coords, chd = "d", 
#                                      chm = "m", chs = "r"))
# 
# ### Make sf for each dam
# cdp_sf <- st_point()
# 
# ### Make vectors for df
# lat_dams <- c(dam_coords_dd[1], dam_coords_dd[3], dam_coords_dd[5])
# lon_dams <- c(dam_coords_dd[2], dam_coords_dd[4], dam_coords_dd[6])
# 
# ### Make df
# dams <- data.frame(cbind(dam_names, lat_dams, lon_dams))
# dams$lat_dams <- as.numeric(as.character(dams$lat_dams))
# dams$lon_dams <- as.numeric(as.character(dams$lon_dams))
# 
# ### Convert to sf
# dams_sf <- st_as_sf(x = dams, 
#                     coords = c("lon_dams", "lat_dams"),
#                     crs = 102033)
# ### Write out to inspect
# st_write(dams_sf, "D:/dinamica/brazil_dinamica_data/proposed_infrastr/dams_sf.shp")
# 
# ### Get one dam
# cdp_sf <- dams_sf %>%
#   filter(dam_names == "Cachoeira dos Patos") %>%
#   st_write(., "D:/dinamica/brazil_dinamica_data/proposed_infrastr/cdp_dam.shp")
# 
# dam_names <- c("Cachoeira dos Patos", "Jardim de Ouro", "Jamanxim")
```
This isn't working and not sure why. Try making kml in Google Earth instead, then convert to shp in ArcGIS, then open here:
```{r}
### Open dams
dam1 <- st_read("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/proposed_infrastr/jardim_dam.shp") %>%
  st_transform(., crs = 102033)
dam2 <- st_read("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/proposed_infrastr/cachoeira_dam.shp") %>%
  st_transform(., crs = 102033)
dam3 <- st_read("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/proposed_infrastr/jamanxim_dam.shp") %>%
  st_transform(., crs = 102033)

### Combine into single sf
all_dams <- rbind(dam1, dam2, dam3)

### Drop excess columns
all_dams <- all_dams %>%
  dplyr::select(., name = Name, geometry)

### Drop z dimension
all_dams <- st_zm(all_dams)

### Write out so can calculate distance raster in Arc
st_write(all_dams, 
         "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/proposed_infrastr/all_proposed_dams.shp")

### export as tif: dist_prop_dams.tif

### Open tif
dams_dist <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/proposed_infrastr/dist_prop_dams.tif")

### Resample to match Jaman raster
dams_resample <- raster::resample(dams_dist, jm_2008, "bilinear")

### Save output raster to folder on ext hard drive
writeRaster(dams_resample,
            filename = "D:/dinamica/brazil_dinamica_data/discourse_analysis_final_layers/bra_dist_proposed_dams.tiff",
            format = "GTiff",
            overwrite = TRUE)
```


## Head of cattle
Municipality-level data from 2017 Censo Agropecuario (https://censos.ibge.gov.br/agro/2017/templates/censo_agro/resultadosagro/pecuaria.html?localidade=15&tema=75652)
```{r}
### Open data
cattle <- read_csv("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/cattle.csv")

### Merge cattle with municipio geometries
cattle <- merge(cattle, braz, 
                by = "municipio",
                all.x = TRUE)
st_geometry(cattle) <- cattle$geometry

### Calculate municipio area (m2)
cattle$municipio_area_m2 <- st_area(cattle)

### Convert to numeric
cattle$municipio_area_m2 <- as.numeric(cattle$municipio_area_m2)

### Convert to municipality in km2
cattle$municipio_area_km2 <- cattle$municipio_area_m2/1000000

### Calculate cattle per km2
cattle <- cattle %>%
  mutate(cattle_km2 = cattle_head/municipio_area_km2)

### Drop excess columns
cattle <- cattle %>%
  dplyr::select(., municipio, cattle_km2, geometry) %>%
  st_write("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/cattle.shp")

### Convert to raster in gdal
### gdal_rasterize -a cattle_km2 -tr 30 30 cattle.shp cattle.tiff

### Open raster
cattle_rast <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/cattle.tiff")

### Resample to match LUC raster (bilinear)
cattle_resample <- raster::resample(cattle_rast, 
                                    jm_2008, "bilinear")

### Save output raster to folder on ext hard drive
writeRaster(cattle_resample,
            filename = "D:/dinamica/brazil_dinamica_data/discourse_analysis_final_layers/bra_cattle.tiff",
            format = "GTiff",
            overwrite = TRUE)

```

## Field research
Locations of field research sites from published lit in Web of Science (searched "Jamanxim," pulled out lat/long of research sites, made kmz in Google Earth, then converted to shp in ArcGIS)
```{r}
### Open shp and reproject
f_r <- st_read("D:/dinamica/brazil_dinamica_data/field_research_sites/jaman_research.shp") %>%
  st_transform(., 102033) 

### Add column for field research site ID
f_r <- f_r %>%
  mutate(., fr_site = 1:nrow(f_r)) %>%
  dplyr::select(., fr_site, geometry)

### Intersect field research sites and jaman buff
f_r <- st_intersection(f_r, jam_big)

### Write out so can calculate distance raster in Arc
st_write(f_r, 
         "D:/dinamica/brazil_dinamica_data/field_research_sites/jam_field_research.shp")

### Make distance raster in ArcGIS. Set max dist to 164400, export as tif: jam_dist_fr.tif

### Open tif
fr_dist <- raster("D:/dinamica/brazil_dinamica_data/field_research_sites/jam_dist_fr.tif")

### Resample to match Jaman raster
fr_resample <- raster::resample(fr_dist, jm_2008, "bilinear")

### Save output raster to folder on ext hard drive
writeRaster(fr_resample,
            filename = "D:/dinamica/brazil_dinamica_data/discourse_analysis_final_layers/jam_dist_fr.tif",
            format = "GTiff",
            overwrite = TRUE)
```

## Fires
```{r}
### Open fire dataset
# fires_bra <- st_read("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/fires/Fires98_18.shp")
fires_bra <- readOGR(dsn = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/fires", 
                     layer = "Fires98_18")

### Convert to sf
fires_bra <- st_as_sf(fires_bra)

### Make column for year
fires_bra <- fires_bra %>%
  mutate(year = year(DataHora))

### Only includes fires from 2007 onward, so keep all years of data

### Transform crs
fires_bra <- st_transform(fires_bra, 
                          crs = 102033)

### Intersect fires and jambuf_big
fires_jam <- st_intersection(fires_bra, jambuf_big)

### Remove excess columns
fires_jam <- fires_jam %>% 
  dplyr::select(., -area, -Area)

### Save sf for making 1) distance and 2) density map in Arc
st_write(fires_jam, 
         "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/fires/fires_jaman.shp")

### For distance to fire, set max dist to 17,300
### bra_dist_fire.tif
### For density, use 1000 map unit radius again
### bra_dens_fire.tif
```

### Resample rasters
```{r}
### Open rasters
dist_fires <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_dist_fire.tif")
dens_fires <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_dens_fire.tif")

### Resample to match ambcar raster
fire_dist_resample <- raster::resample(dist_fires, 
                                       jm_2008, 
                                       "bilinear")
fire_dens_resample <- raster::resample(dens_fires,
                                       jm_2008,
                                       "bilinear")

### Save output rasters to folder
writeRaster(fire_dist_resample,
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_fire_dist_re.tiff",
            format = "GTiff",
            overwrite = TRUE)
writeRaster(fire_dens_resample,
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_fire_dens_re.tiff",
            format = "GTiff",
            overwrite = TRUE)
```

## Distance to urban areas
Reclassify classified raster in ArcGIS to have a raster with urban areas (every other class = NoData)--> bra_08_urb_r.tif; bra_18_urb_r.tif

Then calculate distance to 2008 urban areas using Euclidean distance tool, set max distance to 39000 --> bra_d_urb.tif

Then resample to match jaman
```{r}
### Open rasters
dist_urb <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/bra_d_urb.tif")

### Resample to match ambcar raster
dist_urb_resample <- raster::resample(dist_urb, 
                                      jm_2008, 
                                      "bilinear")

### Save output rasters to folder
writeRaster(dist_urb_resample,
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_urban_dist_re.tiff",
            format = "GTiff",
            overwrite = TRUE)
```

## Distance to ag
Reclassify classified raster in ArcGIS to have a raster with ag areas (every other class = NoData)--> bra_08_ag_r.tif; bra_18_ag_r.tif

Then calculate distance to 2008 ag areas using Euclidean distance tool, set max distance to 15000 --> bra_d_ag.tif

Then resample to match jaman
```{r}
### Open rasters
dist_ag <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/bra_d_ag.tif")

### Resample to match ambcar raster
dist_ag_resample <- raster::resample(dist_ag, 
                                     jm_2008, 
                                     "bilinear")

### Save output rasters to folder
writeRaster(dist_ag_resample,
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_ag_dist_re.tiff",
            format = "GTiff",
            overwrite = TRUE)
```

## Illegal mining
Illegal mining across Amazon, from https://www.amazoniasocioambiental.org/es/mapas/#descargas. Three files: points, lines, polygons. Open here and combine into single shp, except leave out lines because lines are never the closest location to study areas and cause gdal issues.
```{r}
### Open points
min_pt <- st_read("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/MineriaIlegal/MineriaIlegal_pt.shp") %>%
  st_transform(., crs = 102033) %>%
  filter(., país %in% c("Brasil"))

# ### Open lines
# min_li <- st_read("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/MineriaIlegal/MineriaIlegal_ln.shp")

### Open polys
min_po <- st_read("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/MineriaIlegal/MineriaIlegal_pol.shp") %>%
  st_transform(., crs = 102033) %>%
  filter(., país %in% c("Brasil"))

### Make geoms valid
min_po <- st_make_valid(min_po)

### Get intersection with municipios in Jamanxim
min_po <- st_intersection(min_po, municipios)

### Drop excess col names
min_po <- min_po %>%
  dplyr::select(., -shape_Leng,
                -shape_Area, -hectares,
                -state, -municipio)

# ### Convert min_po to points
# min_po_pt <- st_cast(min_po, "POINT")

### Make points along perimeter of polygons
### Get minimum distance between any two points
# min_po %>% 
#   st_simplify(TRUE, dTolerance = 5000) %>% 
#   st_cast("MULTIPOLYGON") %>% 
#   st_coordinates() %>% 
#   as.data.frame() %>% 
#   st_as_sf(coords = c("X", "Y")) %>% 
#   st_distance() %>%  c() %>% 
#   unique() %>% 
#   sort
### min dist = 0.3404727

poly_points <- st_segmentize(min_po, dfMaxLength = 0.34) %>%
  st_simplify(TRUE, dTolerance = 5000) %>% 
  st_cast("MULTIPOLYGON") %>% st_coordinates() %>%
  as.data.frame() %>% 
  dplyr::select(X, Y) %>% 
  st_as_sf(coords = c("X", "Y"))
# st_write(poly_points, 
#          "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/illegal_mining_perims.shp")

### Update crs
poly_points_crs <- poly_points %>%
  st_set_crs(st_crs(min_pt))

### Remove excess cols from pts 
min_pt <- min_pt %>%
  dplyr::select(., geometry)

### Combine
all_min <- rbind(min_pt, poly_points_crs)

### Write out shp to make distance raster in Arc
st_write(all_min,
         "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/mineria_ilegal.shp")

### Make distance raster in Arc --> bra_dist_ill_mines.tif

### Resample
### Open rasters
dist_ill_min <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/bra_dist_ill_mines.tif")

### Resample to match ambcar raster
dist_ill_min_resample <- raster::resample(dist_ill_min, 
                                          jm_2008, 
                                          "bilinear")

### Save output rasters to folder
writeRaster(dist_ill_min_resample,
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_dist_illegal_mines.tiff",
            format = "GTiff",
            overwrite = TRUE)

```

## Precip
File from Eva (GEE), reprojected to 102033 in gdal
```{r}
### Open raster
precip <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/ppt_jaman_102033.tif")

### Resample to match ambcar raster
precip_resample <- raster::resample(precip, 
                                    jm_2008, 
                                    "bilinear")

### Save output rasters to folder
writeRaster(precip_resample,
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_ppt.tiff",
            format = "GTiff",
            overwrite = TRUE)
```

## Soil moisture
```{r}
### Open raster
soil <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/sm_jaman_102033.tif")

### Resample to match ambcar raster
soil_resample <- raster::resample(soil, 
                                  jm_2008, 
                                  "bilinear")

### Save output rasters to folder
writeRaster(soil_resample,
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_soil.tiff",
            format = "GTiff",
            overwrite = TRUE)
```

## PADDD
There were proposals to de-gazette the entire FLONA in 2006 and again in 2008 (reversed in 2012 and 2016, respectively). So layers for that wouldn't have any spatial differentiation. But there was also a proposal in 2016 to downgrade portions of the park because of rural settlements. This was reversed in 2017 but still might have an effect on deforestation patterns. PADDD_ID = BRA989173F7
```{r}
### Open PADDD events in Brazil
paddd <- st_read("C:/Users/Katherine Siegel/Documents/SESYNC/Meeting2_data/PADDDtracker_DataReleaseV2_May2019/paddd_events.shp") %>%
  st_transform(., crs = 102033) %>%
  filter(., ISO3166 == "BRA")

### Subset to 2016 downgrading proposal
paddd <- paddd %>%
  filter(., PADDD_ID == "BRA989173F7") %>%
  dplyr::select(., status = EnactedPro, geometry)

### Get rest of jaman shp
no_paddd <- st_difference(jambuf, st_union(paddd))

### Make same cols for no_paddd
no_paddd <- no_paddd %>%
  dplyr::select(., status = Type, geometry)

### Combine SFs
paddd_jam <- rbind(paddd, no_paddd)

### Add column for paddd
paddd_jam$paddd <- ifelse(paddd_jam$status == "Proposed",
                          1, 0)
paddd_jam$paddd <- as.factor(paddd_jam$paddd)
paddd_jam <- dplyr::select(paddd_jam, paddd, geometry)

### Write out shp to rasterize in gdal
st_write(paddd_jam, 
         "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/paddd_proposal.shp")

### gdal_rasterize -a paddd -tr 30 30 paddd_proposal.shp paddd_proposal.tif

### Open raster
paddd_ras <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/paddd_proposal.tif")

### Resample raster
paddd_ras_resample <- raster::resample(paddd_ras,
                                       jm_2008,
                                       "ngb")

### Save output rasters to folder
writeRaster(paddd_ras_resample,
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_paddd.tiff",
            format = "GTiff",
            overwrite = TRUE)
```

## Protection status
```{r}
### Open file
prot_stat <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/jaman_w_buffer.tiff")

### Resample
prot_resample <- raster::resample(prot_stat, 
                                  jm_2008, 
                                  "ngb")

### Write out
writeRaster(prot_resample,
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_prot_status.tiff",
            format = "GTiff",
            overwrite = TRUE)
```

## Poverty rate
Data per municipio from IBGE (2003 data). 
cidades.ibge.gov.br, then select metric, then municipio. 
https://cidades.ibge.gov.br/brasil/pa/novo-progresso/pesquisa/36/30246?localidade1=150060&localidade2=150360
```{r}
### Open poverty csv
pov <- read_csv("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/poverty_rate.csv")

### Combine with sfs
municip_pov <- merge(municipios, pov,
                     by = "municipio")

### Select cols to keep
municip_pov <- municip_pov %>%
  dplyr::select(., pov_rate, geometry)

### Write out to rasterize in gdal
st_write(municip_pov,
         "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/poverty_rate.shp")

### Open raster to resample
pov_ras <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/poverty_rate.tif")

### Resample
pov_resample <- raster::resample(pov_ras, 
                                 jm_2008, 
                                 "ngb")

### Write out
writeRaster(pov_resample,
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_pov_rate.tiff",
            format = "GTiff",
            overwrite = TRUE)
```

## Distance to cities
List of cities from Mongabay, https://population.mongabay.com/population/brazil
"Largest cities in Brazi," 2019. Located cities in Google Earth, converted to shp in ArcMap.
```{r}
### Open city shp
cities <- st_read("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/brasil_cidades.shp") %>%
  st_transform(., crs = 102033)

### Drop z dimension
cities <- st_zm(cities)

### Write out to make distance raster
st_write(cities, 
         "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/brasil_cidades_102033.shp")

### Make distance raster --> jam_d_city.tif (used municip_region as processing extent, then clipped down)

### Read in distance raster
d_cities <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/jam_d_city.tif")

### Resample to match Jamanxim
cities_resample <- raster::resample(d_cities, 
                                    jm_2008, 
                                    "bilinear")

### Write out
writeRaster(cities_resample,
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_dist_cities.tiff",
            format = "GTiff",
            overwrite = TRUE)
```

## Land tenure  
Background notes (Ezzine-de-Blas et al. 2011):  
* Brazilian Federal Land Reform began in 1964, National Institute for Agrarian Reform (INCRA)  
* projectos fundiarios: > 8500 settlements for landless peasants, mostly in Legal Amazon  

### Atlas of Braz Ag
http://atlasagropecuario.imaflora.org/
"BD_CategoriasFundiarias_DB_LandTenureCategories" files have land tenure type as raster: a11_LTcategories_v170321.tif
```{r}
### Open file
tenure <- raster("D:/dinamica/brazil_dinamica_data/atlas_da_agropecuaria/BD_CategoriasFundiarias_DB_LandTenureCategories/a11_LTcategories_v170321.tif")

### Get projection of raster
tenure

### Convert municipios to same crs as raster
municipios_rpj <- st_transform(municipios, 
                               crs = "+proj=aea +lat_1=-2 +lat_2=-22 +lat_0=-12 +lon_0=-54 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs")
# st_write(municipios_rpj,
#          "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/municipios_rpj.shp")

### Convert municipios to sp
municipios_sp <- as(municipios_rpj, 'Spatial')

### Crop tenure map to municipios
tenure_jmx <- raster::crop(tenure, municipios_sp,
                           method = "ngb")

### Mask out values outside of municipios
tenure_jmx_mask <- raster::mask(tenure_jmx, municipios_sp)
# plot(tenure_jmx_mask, axes = FALSE)
# plot(municipios_sp, add = TRUE)
writeRaster(tenure_jmx_mask,
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/land_tenure_cropped.tiff",
            format = "GTiff")

### Project raster to 102033
tenure_rpj <- projectRaster(tenure_jmx_mask, 
                            crs=crs(municipios),
                            method = "ngb")

# hist(tenure_rpj)

### Write out both for zonal stats in Arc
writeRaster(tenure_rpj,
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/land_tenure.tiff",
            format = "GTiff")
st_write(municipios, "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/municipios.shp")

# ### Extract raster data to polygons
# ten_ext <- extract(tenure_rpj, municipios)
```

#### Area per class
By municipio
```{r}
################# Altamira ##############3
### Make raster just for Altamira
alta <- municipios %>%
  filter(., municipio == "Altamira")

### Crop tenure map to alta
tenure_alta <- raster::crop(tenure_rpj, alta,
                            method = "ngb")

### Mask out values outside of municipios
tenure_alta_mask <- raster::mask(tenure_alta, alta)

### Calculate area per class
area_per_class <- as.data.frame(tenure_alta_mask) %>%
  group_by(a11_LTcategories_v170321) %>%
  tally() %>%
  mutate(area = n * res(tenure_alta_mask)[1] * res(tenure_alta_mask)[2])

### Add column for area of municipio
area_per_class <- area_per_class %>%
  mutate(municip_area = st_area(alta)) %>%
  mutate(m_area = 159687117267) %>%
  mutate(porportion_class = area/m_area)

### Add col for municipio name
area_per_class <- area_per_class %>%
  mutate(municip = "Altamira")

################# Itaituba ##############
### Make raster just for Itaituba
itai <- municipios %>%
  filter(., municipio == "Itaituba")

### Crop tenure map to itai
tenure_itai <- raster::crop(tenure_rpj, itai,
                            method = "ngb")

### Mask out values outside of municipios
tenure_itai_mask <- raster::mask(tenure_itai, itai)

### Calculate area per class
area_per_class_itai <- as.data.frame(tenure_itai_mask) %>%
  group_by(a11_LTcategories_v170321) %>%
  tally() %>%
  mutate(area = n * res(tenure_itai_mask)[1] * res(tenure_itai_mask)[2])

### Add column for area of municipio
area_per_class_itai <- area_per_class_itai %>%
  mutate(municip_area = st_area(itai)) %>%
  mutate(m_area = 62036244622) %>%
  mutate(porportion_class = area/m_area)

### Add col for municipio name
area_per_class_itai <- area_per_class_itai %>%
  mutate(municip = "Itaituba")

################# Novo Progresso ##############
### Make raster just for Itaituba
novo <- municipios %>%
  filter(., municipio == "Novo Progresso")

### Crop tenure map to novo
tenure_novo <- raster::crop(tenure_rpj, novo,
                            method = "ngb")

### Mask out values outside of municipios
tenure_novo_mask <- raster::mask(tenure_novo, novo)

### Calculate area per class
area_per_class_novo <- as.data.frame(tenure_novo_mask) %>%
  group_by(a11_LTcategories_v170321) %>%
  tally() %>%
  mutate(area = n * res(tenure_novo_mask)[1] * res(tenure_novo_mask)[2])

### Add column for area of municipio
area_per_class_novo <- area_per_class_novo %>%
  mutate(municip_area = st_area(novo)) %>%
  mutate(m_area = 38171888133) %>%
  mutate(porportion_class = area/m_area)

### Add col for municipio name
area_per_class_novo <- area_per_class_novo %>%
  mutate(municip = "Novo Progresso")

################################3
### Combine dfs
area_per <- rbind(area_per_class,
                  area_per_class_itai, 
                  area_per_class_novo)

### Category 5 = non-designated land
area_nondes <- area_per %>%
  filter(., a11_LTcategories_v170321 == "5") %>%
  dplyr::select(., municipio = municip, 
                proportion_class = porportion_class)

### Merge with sf
municipio_area_nondes <- merge(municipios, area_nondes,
                               by = "municipio")

### Save sf to rasterize in gdal
st_write(municipio_area_nondes,
         "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/nonalloc_by_municip.shp")

### Open raster
tenure_rast <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/nonalloc_by_municip.tiff")

### Resample to match jaman
tenure_resample <- raster::resample(tenure_rast, 
                                    jm_2008, 
                                    "bilinear")

### Save output rasters to folder
writeRaster(tenure_resample,
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_nonalloc_land.tiff",
            format = "GTiff",
            overwrite = TRUE)
```


### INCRA files
```{r}
### Parcela Regularização
regular_parc <- st_read("D:/dinamica/brazil_dinamica_data/incra_land_tenure/Parcela Regularização_PA.shp") %>%
  st_transform(., crs = 102033)
### Modality: Electronic auction, Competition, Invitation
### Situacao: Non-titled, Registered, Titled but not registered, <NA>
### Status: Titling, Tax approval

### Immovel certificado SIGEF Total
immovel_sigef <- st_read("D:/dinamica/brazil_dinamica_data/incra_land_tenure/Sigef Brasil_PA.shp") %>%
  st_transform(., crs = 102033)
### Situacao: Non-titled, Registered, Titled but not registered, <NA>
### Status: Certified, Registered

### Immovel certificado SNCI Total  
immovel_snci <- st_read("D:/dinamica/brazil_dinamica_data/incra_land_tenure/Imóvel certificado SNCI Brasil_PA.shp") %>%
  st_transform(., crs = 102033)
### Certified

### Projectos de assentamento total
assentamento <- st_read("D:/dinamica/brazil_dinamica_data/incra_land_tenure/Assentamento Brasil_PA.shp") %>%
  st_transform(., crs = 102033)
```

#### Ag Reform Settlements
Locations of ag reform settlements within Jamanxim and buffer
```{r}
### Intersect ag reform settlements with jaman
assentamento_jaman <- st_intersection(assentamento,
                                       jambuf)

### There are 4 ag reform settlements that overlap with Jamanxim. All are classified as "assentamento criado."

assentamento_jaman$burn_in <- 1

### Write out the shp and then rasterize in gdal
assentamento_jaman %>% 
  dplyr::select(., burn_in, geometry) %>%
  st_write(., 
           "D:/dinamica/brazil_dinamica_data/incra_land_tenure/assent_jam.shp")

### Use gdal to rasterize: 
### gdal_rasterize -a burn_in -tr 30 30 assent_jam.shp assent_jam.tif

### Open tif from gdal
jaman_tif <- raster("D:/dinamica/brazil_dinamica_data/incra_land_tenure/assent_jam.tif")

### Resample to match Jamanxim raster (use "ngb" since binary settlement/nonsettlement)
jaman_resample <- raster::resample(jaman_tif, 
                                   jm_2008, 
                                   "ngb")

### Extend raster to match extent of Jamanxim
jaman_resample_lg <- raster::extend(jaman_resample,
                                    jm_2008,
                                    value = 0)

### Save output raster to folder on ext hard drive
writeRaster(jaman_resample_lg,
            filename = "D:/dinamica/brazil_dinamica_data/discourse_analysis_final_layers/bra_agreform_settlements.tiff",
            format = "GTiff",
            overwrite = TRUE)

### Clear old files
rm(jaman_resample, jaman_resample_lg, 
   assentamento, assentamento_jaman)
```

#### Land titling
```{r}
### Is there overlap between regular_parc and immovel_sigef?
### Crop both to Jamanxim municipios
parc_municipios <- st_intersection(regular_parc,
                              municipios) %>%
  dplyr::select(., parcela_co, situacao_i, status, 
                municipio, geometry)
sigef_municipios <- st_intersection(immovel_sigef,
                               municipios) %>%
  dplyr::select(., parcela_co, situacao_i, status, 
                municipio, geometry)
# ### Check overlap
# parc_sigef <- st_intersection(parc_municipios,
#                               sigef_municipios)
# ### There is some overlap in the areas

### Combine sf objects
parc_municipios$data <- "parc_municipios"
sigef_municipios$data <- "parc_sigef"
parc_sigef <- rbind(parc_municipios,
                    sigef_municipios)

### Subset to non-titled and nonregistered
nontitled <- subset(parc_sigef, 
                    situacao_i == "NAOTITULADA")

### Add area for geometries
nontitled$area <- st_area(nontitled$geometry)

### Sum area by municipio
area_per_mun <- nontitled %>%
  group_by(municipio) %>%
  summarise(total_area = sum(area)) %>%
  ungroup()

### Get area of total municipio
municipios$area <- st_area(municipios$geometry)

### Reduce columns
municipios <- municipios %>% 
  dplyr::select(., municipio, area)
st_geometry(area_per_mun) <- NULL
area_per_mun <- area_per_mun %>%
  dplyr::select(., municipio, total_area)

### Combine
area_per_mun <- merge(area_per_mun, municipios, 
                      by = "municipio")

### Calculate nontitled area per municipio
area_per_mun$proportion_nontitled <- area_per_mun$total_area/area_per_mun$area
area_per_mun$proportion_nontitled <- as.numeric(area_per_mun$proportion_nontitled)

### Resort columns
area_per_mun <- area_per_mun %>%
  dplyr::select(., proportion_nontitled, geometry)
st_geometry(area_per_mun) <- area_per_mun$geometry
st_write(area_per_mun, 
         "D:/dinamica/brazil_dinamica_data/incra_land_tenure/nontitled_para.shp")

### Use gdal to rasterize: 
### gdal_rasterize -a burn_in -tr 30 30 assent_jam.shp assent_jam.tif

# ### Intersect with Jamanxim
# area_per_mun_jam <- st_intersection(area_per_mun, jambuf)
# 
# ### Drop excess columns, then write out the shp to rasterize in gdal
# area_per_mun_jam <- area_per_mun_jam %>%
#   dplyr::select(., -area, -Type, -Area, -tp_uso,
#                 -nome, -Date, -Source) %>%
#   st_write(., "D:/dinamica/brazil_dinamica_data/incra_land_tenure/nontitled_jam.shp")

### Use gdal to rasterize: 
### gdal_rasterize -a burn_in -tr 30 30 assent_jam.shp assent_jam.tif


```

## Raster brick
### Brazil simple
```{r}
### File pattern
raster_list <- list.files("D:/dinamica/brazil_simple/data", 
                          full.names=TRUE)

#### Open layers
aspect <- raster("D:/dinamica/brazil_simple/data/aspect_jaman.tif")
crop_suit <- raster("D:/dinamica/brazil_simple/data/bra_cropsuit_resample.tif")
cities <- raster("D:/dinamica/brazil_simple/data/bra_dist_cities.tif")
mines <- raster("D:/dinamica/brazil_simple/data/bra_dist_mines_resample.tif")
rivers <- raster("D:/dinamica/brazil_simple/data/bra_dist_rios_resample.tif")
roads <- raster("D:/dinamica/brazil_simple/data/bra_osm_dist_resample.tif")
popdens <- raster("D:/dinamica/brazil_simple/data/bra_pd_resample.tif")
poverty <- raster("D:/dinamica/brazil_simple/data/bra_pov_rate.tif")
ppt <- raster("D:/dinamica/brazil_simple/data/bra_ppt.tif")
prot_status <- raster("D:/dinamica/brazil_simple/data/bra_prot_status.tif")
soil <- raster("D:/dinamica/brazil_simple/data/bra_soil.tif")
elev <- raster("D:/dinamica/brazil_simple/data/dem_jaman_102033.tif")
slope <- raster("D:/dinamica/brazil_simple/data/slope_jaman.tif")

#### Brick them
brick_layers <- raster::brick(aspect, mines, 
                              roads, rivers, 
                              cities, elev, 
                              popdens, poverty, 
                              ppt, prot_status, 
                              slope, soil, 
                              crop_suit)

### Write out brick
writeRaster(brick_layers, 
            filename = "D:/dinamica/brazil_simple/data/brazil_static_vars.tif", 
            format = "GTiff",
            overwrite = TRUE, 
            options = c("INTERLEAVE=BAND","COMPRESS=LZW"))
```

### Brazil DA
Discourse analysis variables:  
* field research  
* PADDD  
* non-allocated land  
* distance to illegal mining  
* distance to ag  
* distance to fires  
* fire density  
* distance to proposed railroads  
* distance to proposed dams  
* ag reform settlements  
* head of cattle  
```{r}
### Location of discourse analysis variables
bra_da_var_loc <- "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/"

### List files in folder
bra_da_var_list <- list.files(path = bra_da_var_loc, 
                              pattern="*.tif",
                              full.names=TRUE)

### Open layers
field_research <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/jam_dist_fr.tif")  
paddd <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_paddd.tif")  
non_all_land <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_nonalloc_land.tif")  
dist_ill_mines <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_dist_illegal_mines.tif")  
dist_ag <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_ag_dist_re.tif")  
dist_fires <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_fire_dist_re.tif")  
fire_dens <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_fire_dens_re.tif")  
dist_proposed_rr <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_dist_proposed_rr.tif")  
dist_proposed_dams <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_dist_proposed_dams.tif")  
agreform_sett <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_agreform_settlements.tif") 
cattle <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/bra_cattle.tif")  

### Brick layers
da_brick <- raster::brick(aspect, mines, 
                          roads, rivers, 
                          cities, elev, 
                          popdens, poverty, 
                          ppt, prot_status, 
                          slope, soil, 
                          crop_suit,
                          field_research, 
                          paddd,
                          non_all_land,
                          dist_ill_mines,
                          dist_ag,
                          dist_fires,
                          fire_dens,
                          dist_proposed_rr,
                          dist_proposed_dams,
                          agreform_sett,
                          cattle)

### Write out brick
writeRaster(da_brick, 
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/brazil_all_layers.tif", 
            format = "GTiff",
            overwrite = TRUE, 
            options = c("INTERLEAVE=BAND","COMPRESS=LZW"))

### Brick with DA layers only
da_only <- raster::brick(field_research, 
                          paddd,
                          non_all_land,
                          dist_ill_mines,
                          dist_ag,
                          dist_fires,
                          fire_dens,
                          dist_proposed_rr,
                          dist_proposed_dams,
                          agreform_sett,
                          cattle)

### Write out brick
writeRaster(da_only, 
            filename = "C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/new_dinamica_layers/brazil/discourse_analysis_final_layers/brazil_da_vars.tif", 
            format = "GTiff",
            overwrite = TRUE, 
            options = c("INTERLEAVE=BAND","COMPRESS=LZW"))
```
