---
title: "regressions"
author: "Katherine Siegel"
date: "February 10, 2020"
output: html_document
---

## Description
Get set of random forested points (2008) and run logistic regression on factors contributing to likelihood of transitioning to another land cover in 2018.

## Set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

### Open packages
library(tidyverse)
library(sf)
library(raster)
```

## Sample points
Sample points that are ag in 2008.
forest, agriculture, urban, water, desert, wetlands, and bare soil
Based on looking at rasters, I assume these are the value/land cover class combinations:  
* 0: no data  
* 1: ag
* 2: forest
* 3: bare soil  
* 4: urban  
* 5: wetland  
* 6: desert (BOL only)  
* 7: water  

### Brazil
```{r}
### Open Brazil 2008 raster
bra_2008 <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/remote_sensing/classi_BRA_dry_2008.tif")

# hist(bra_2008,
#      main = "Distribution of land cover classes",
#      xlab = "Land cover class", ylab = "Frequency",
#      col = "springgreen")

### Reclassification matrix (want forests + NA only)
reclass_df <- c(-1, 1.1, NA, ## change NoData, ag to NA
                1.9, 2.1, 1, ## forest = 1
                2.9, 10, NA) ## all other classes = NA
reclass_m <- matrix(reclass_df,
                ncol = 3,
                byrow = TRUE)

### Reclassify raster
bra_2008_recl <- reclassify(bra_2008, reclass_m)
hist(bra_2008_recl,
     main = "Distribution of land cover classes",
     xlab = "Land cover class", ylab = "Frequency",
     col = "springgreen")

### Make function to sample non-NA cells
### r: raster, n: number of points
### source: https://gis.stackexchange.com/questions/207119/sampling-random-points-from-large-raster-file-with-replacement-using-r
fastRandomPoints <- function(r, n) {
  if(raster::nlayers(r) > 1) r <- r[[1]]
  v <- raster::getValues(r)
  v.notNA <- which(!is.na(v))
  x <- sample(v.notNA, n)
  pts <- raster::xyFromCell(r, x)
  return(pts)
}

### Get sample of points that are forest (1) in 2008
### Tried with sample of 1000 pts but didn't get enough points with a transition (59 turned to ag, 8 to bare soil, 1 to wetland)
forest_pts <- fastRandomPoints(r = bra_2008_recl,
                               n = 10000)

### Make it a df
forest_pts <- as_data_frame(forest_pts) %>%
  rownames_to_column(., "sample_pt")

### Convert to sf
forest_pts_sf <- st_as_sf(x = forest_pts,
                          coords = c("x", "y"),
                          crs = "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")

### Save sf df
st_write(forest_pts_sf, "bra_pts_for_regression.shp")
```

#### See LUC in 2018 for pts
```{r}
### Convert to sp
forest_pts_sp <- as(forest_pts_sf, "Spatial")

### Open 2018 raster
bra_2018 <- raster("C:/Users/Katherine Siegel/Documents/SESYNC/dinamica/remote_sensing/classi_BRA_dry_2018.tif")

### Extract raster values to sample pts
luc_2018 <- raster::extract(bra_2018, forest_pts_sp, df = TRUE)

### Histogram and summary
hist(luc_2018$classi_BRA_dry_2018)
luc_2018_summ <- luc_2018 %>% 
  group_by(classi_BRA_dry_2018) %>% 
  summarise(pts_per_class = n())

### 1000 points doesn't give enough transition points
```

